<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game (PNG Assets)</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: Arial; overflow: hidden; }
    #gameCanvas { display: block; width: 100%; height: 80vh; background: black; }
    #homeScreen, #leaderboardScreen {
      position: absolute; top:0; left:0; right:0; bottom:0;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.9);
    }
    #leaderboardScreen { display: none; }
    #startBtn { padding: 10px 20px; background: gold; border:none; border-radius:10px; font-size:20px; cursor:pointer; }
    table { width:90%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #444; padding:5px; text-align:center; }
    th { background:#222; }
    button { margin:2px; padding:5px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Home screen -->
  <div id="homeScreen">
    <h1>üöÄ Space Rocket</h1>
    <button id="startBtn" disabled>Start Game</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Leaderboard -->
  <div id="leaderboardScreen">
    <h2>üèÜ Leaderboard</h2>
    <table>
      <thead>
        <tr><th>–ù—ç—Ä</th><th>–û–Ω–æ–æ</th><th>–û–Ω —Å–∞—Ä</th><th id="adminCol"></th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button onclick="restart()">üîÑ –î–∞—Ö–∏–Ω —Ç–æ–≥–ª–æ—Ö</button>
  </div>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child, remove, update } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.firebasestorage.app",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42",
      measurementId: "G-94EH113TS5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Telegram WebApp user
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe?.user;
    let currentUser = "guest";
    if (user) currentUser = user.username || (user.first_name + " " + (user.last_name||""));

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.8;

    const homeScreen = document.getElementById("homeScreen");
    const leaderboardScreen = document.getElementById("leaderboardScreen");
    const startBtn = document.getElementById("startBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const adminCol = document.getElementById("adminCol");

    let score = 0;
    let rocket = { x: canvas.width/2-50, y: canvas.height-150, width:100, height:100 };
    let obstacles = [];
    let coins = [];
    let running = false;

    // Assets (PNG –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞)
    const rocketImg = new Image(); rocketImg.src = "assets/rocket.png";
    const obstacleImg = new Image(); obstacleImg.src = "assets/obstacle.png";
    const coinImg = new Image(); coinImg.src = "assets/coin.png";

    // Preload check
    let loaded = 0;
    const total = 3;
    function onAsset(){ loaded++; if (loaded===total) startBtn.disabled=false; }
    rocketImg.onload=onAsset; obstacleImg.onload=onAsset; coinImg.onload=onAsset;

    // Swipe control
    let touchStartX=null, touchStartY=null;
    canvas.addEventListener("touchstart", e => { 
      touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; 
    });
    canvas.addEventListener("touchend", e => {
      if (!touchStartX||!touchStartY) return;
      let dx = e.changedTouches[0].clientX - touchStartX;
      let dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx)>Math.abs(dy)) {
        if (dx>30) rocket.x += 50;
        if (dx<-30) rocket.x -= 50;
      } else {
        if (dy>30) rocket.y += 50;
        if (dy<-30) rocket.y -= 50;
      }
      touchStartX=touchStartY=null;
    });

    // Start game
    startBtn.onclick = () => {
      if (loaded<total) return;
      homeScreen.style.display="none";
      score=0; obstacles=[]; coins=[];
      rocket.x=canvas.width/2-50; rocket.y=canvas.height-150;
      running=true;
      requestAnimationFrame(loop);
    };

    function spawnObstacle() {
      obstacles.push({ x: Math.random()*(canvas.width-80), y:-80, w:80, h:80 });
    }
    function spawnCoin() {
      coins.push({ x: Math.random()*(canvas.width-40), y:-40, w:40, h:40 });
    }

    function loop() {
      if (!running) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.width, rocket.height);

      if (Math.random()<0.02) spawnObstacle();
      obstacles.forEach(o => { o.y+=4; ctx.drawImage(obstacleImg,o.x,o.y,o.w,o.h); });
      obstacles = obstacles.filter(o=>o.y<canvas.height);

      if (Math.random()<0.02) spawnCoin();
      coins.forEach(c => { c.y+=3; ctx.drawImage(coinImg,c.x,c.y,c.w,c.h); });
      coins = coins.filter(c=>c.y<canvas.height);

      for (let o of obstacles) {
        if (checkCollision(rocket,o,15)) { endGame(); return; }
      }
      for (let i=coins.length-1;i>=0;i--) {
        if (checkCollision(rocket,coins[i],10)) { score++; coins.splice(i,1); }
      }

      ctx.fillStyle="white"; ctx.font="20px Arial";
      ctx.fillText("–û–Ω–æ–æ: "+score,10,30);

      requestAnimationFrame(loop);
    }

    function checkCollision(a,b,pad=0){
      return (a.x+pad)<(b.x+b.w-pad) &&
             (a.x+a.width-pad)>(b.x+pad) &&
             (a.y+pad)<(b.y+b.h-pad) &&
             (a.y+a.height-pad)>(b.y+pad);
    }

    async function endGame() {
      running=false;
      const scoresRef = ref(db,"scores");
      const snapshot = await get(child(ref(db),"scores/"+currentUser));
      let totalScore = score;
      if (snapshot.exists()) {
        const old = snapshot.val();
        totalScore = (old.score||0) + score;
      }
      await set(ref(db,"scores/"+currentUser),{ username:currentUser, score:totalScore, createdAt:new Date().toISOString() });
      showLeaderboard();
    }

    async function showLeaderboard() {
      leaderboardScreen.style.display="flex";
      leaderboardBody.innerHTML="";
      const snapshot = await get(child(ref(db),"scores"));
      if (snapshot.exists()) {
        let data = Object.values(snapshot.val());
        data.sort((a,b)=>b.score-a.score);
        data.forEach(row=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${row.username}</td><td>${row.score}</td><td>${new Date(row.createdAt).toLocaleString()}</td>`;
          leaderboardBody.appendChild(tr);
        });
      }
    }

    window.restart=()=>{ leaderboardScreen.style.display="none"; homeScreen.style.display="flex"; };
  </script>
</body>
</html>