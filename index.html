<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>BilzorX</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f1a;
      --card: #101727cc;
      --txt: #eaf2ff;
      --muted: #9fb3ce;
      --accent: #ffd54a;
      --accent2: #58d3ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 70% -10%, #16213e 0%, #0b0f1a 55%, #090d16 100%);
      color: var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden;
    }
    h1, h2, .btn, th, td.score { font-family: 'Press Start 2P', cursive, monospace; }

    /* Top-left user badge */
    #userInfo {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, #0f1430aa, #0c1126aa);
      box-shadow: 0 8px 24px #0006, inset 0 0 0 1px #ffffff08;
      backdrop-filter: blur(8px);
    }
    #userPhoto { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
    #userName { font-weight: 600; color: #fff; font-size: 14px; }
    #userCoins { font-weight: 600; color: var(--accent2); font-size: 14px; }

    /* Screens */
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 15;
      background: linear-gradient(180deg, #0a0f1ab3, #0a0f1acc);
      backdrop-filter: blur(6px);
    }
    #homeScreen {
      background: radial-gradient(ellipse at center, #0f1426 0%, #090c16 100%);
      text-align: center;
      padding: 0;
    }
    .home-content {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    /* Inventory Screen */
    #inventoryScreen {
      display: none;
      background: radial-gradient(ellipse at bottom, #0d1120 0%, #070913 100%);
      padding: 16px;
    }
    #inventoryContainer {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }
    .inventory-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .inventory-header h2 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .inventory-header p {
      font-size: 14px;
      color: var(--muted);
    }
    .skin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      padding: 0 10px;
    }
    .skin-card {
      background: rgba(16, 23, 39, 0.7);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.2s;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .skin-card:active {
      transform: scale(0.96);
    }
    .skin-card.equipped {
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(255, 213, 74, 0.3);
    }
    .skin-card.locked {
      filter: grayscale(1) brightness(0.5);
      position: relative;
    }
    .skin-card.locked::after {
      content: "üîí";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
    }
    .skin-preview {
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.2);
    }
    .skin-preview img {
      max-width: 70%;
      max-height: 70%;
      object-fit: contain;
    }
    .skin-name {
      padding: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .inventory-footer {
      display: flex;
      justify-content: center;
      padding: 16px;
      margin-top: 16px;
      background: rgba(9, 12, 22, 0.8);
    }
    #backFromInventory {
      position: absolute;
      top: 60px;
      left: 12px;
      z-index: 20;
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Pause Screen */
    #pauseScreen {
      display: none;
      background: radial-gradient(ellipse at center, #0f1426 0%, #090c16 100%);
      text-align: center;
      padding: 20px;
    }
    #pauseScreen .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Pause Button */
    #pauseBtn {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 20;
      padding: 8px 16px;
      font-size: 14px;
      display: none;
    }

    /* Rocket GIF container */
    #rocketGif {
      position: absolute;
      width: 120px;
      height: 120px;
      pointer-events: none;
      z-index: 10;
    }
    #rocketGifImg {
      width: 100%;
      height: 100%;
      display: none;
    }

    /* NYAN Cat GIF container and animation */
    #nyanCatGif {
      position: absolute;
      pointer-events: none;
      display: none;
      width: 530px; /* Adjusted to Nyan Cat GIF dimensions */
      height: 210px; /* Adjusted to Nyan Cat GIF dimensions */
      z-index: 11;
      transition: transform 0.1s ease-out, opacity 0.1s ease-out; /* For collect animation */
    }
    #nyanCatGif.collecting {
        transform: scale(1.2); /* Scale up */
        opacity: 0; /* Fade out */
    }


    /* Canvas */
    #gameCanvas {
      display: block;
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 5;
    }

    /* Buttons */
    .btn {
      border: 0;
      cursor: pointer;
      background: linear-gradient(180deg, #ffd54a, #ffb300);
      color: #2b1900;
      font-weight: 700;
      letter-spacing: 0.3px;
      padding: 8px 16px;
      border-radius: 10px;
      box-shadow: 0 6px 15px #ffb30052, inset 0 0 0 1px #ffffff08;
      transition: transform 0.08s ease, filter 0.2s ease, box-shadow 0.2s ease;
      font-size: 14px;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }

    .btn-secondary {
      background: linear-gradient(180deg, #3d4c6e, #2c3a5a);
      color: var(--txt);
    }

    /* Leaderboard styles */
    #leaderboardScreen { display: none; }
    #boardCard {
      width: min(600px, 96vw);
      background: var(--card);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 12px 36px #0009, inset 0 0 0 1px #ffffff08;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #1d2740; }
    th { color: #cfe1ff; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; }
    td.rank { width: 48px; text-align: center; color: #7ec1ff; }
    td.score { font-weight: 700; color: #fff; font-size: 12px; }
    .pill {
      padding: 5px 8px;
      border-radius: 999px;
      background: #ffffff10;
      color: #dbe9ff;
      font-size: 10px;
    }
    .top1 .score { color: #ffd54a; }
    .top2 .score { color: #c0e1ff; }
    .top3 .score { color: #ffc9a8; }
    .footerRow { display: flex; justify-content: space-between; gap: 6px; margin-top: 12px; }
    .ghost { background: #ffffff14; color: #fff; }

    /* Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .floating {
      animation: float 3s ease-in-out infinite;
    }

    /* Responsive design for mobile */
    @media (max-width: 600px) {
      .home-content {
        padding: 15px;
      }
      .inventory-header h2 {
        font-size: 18px;
      }
      .inventory-header p {
        font-size: 12px;
      }
      .skin-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        padding: 0 8px;
      }
      .skin-card {
        border-radius: 8px;
      }
      .skin-preview img {
        max-width: 65%;
        max-height: 65%;
      }
      .skin-name {
        font-size: 10px;
        padding: 6px;
      }
      #backFromInventory {
        padding: 6px 12px;
        font-size: 12px;
      }
      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      #inventoryContainer {
        max-width: 100%;
      }
      .inventory-footer {
        padding: 12px;
      }
      #rocketGif {
        width: 100px;
        height: 100px;
      }
      #pauseBtn {
        padding: 6px 12px;
        font-size: 12px;
      }
      /* Adjust NYAN Cat GIF for smaller screens if needed */
      #nyanCatGif {
        width: 265px; /* Half of 530px */
        height: 105px; /* Half of 210px */
      }
    }
  </style>
</head>
<body>
  <!-- User profile badge -->
  <div id="userInfo" style="display:none;">
    <img id="userPhoto" alt="User profile photo" />
    <span id="userName"></span>
    <span id="userCoins"></span>
  </div>

  <!-- Home screen -->
  <div id="homeScreen" class="screen">
    <div class="home-content">
      <h1>BilzorX</h1>
      <div class="btn-row">
        <button id="startBtn" class="btn">üöÄ LAUNCH GAME</button>
        <button id="openBoardBtn" class="btn secondary">üèÜ LEADERBOARD</button>
      </div>
      <div class="btn-row">
        <button id="openInventoryBtn" class="btn secondary">üé® INVENTORY</button>
      </div>
    </div>
  </div>

  <!-- Inventory screen -->
  <div id="inventoryScreen" class="screen">
    <button id="backFromInventory" class="btn">‚¨Ö BACK TO HOME</button>
    <div id="inventoryContainer">
      <div class="inventory-header">
        <h2>üöÄ ROCKET SKINS</h2>
        <p>Unlock new skins by collecting coins in the game</p>
      </div>
      <div class="skin-grid" id="skinGrid"></div>
      <div class="inventory-footer">
        <div class="pill" id="coinsDisplay">COINS: 0</div>
        <div class="pill" id="nyanCoinsDisplay" style="margin-left: 10px;">NYAN COINS: 0</div>
      </div>
    </div>
  </div>

  <!-- Pause screen -->
  <div id="pauseScreen" class="screen">
    <div class="home-content">
      <h2>PAUSED</h2>
      <div class="btn-row">
        <button id="resumeGame" class="btn">‚ñ∂ RESUME</button>
        <button id="goHomeFromPause" class="btn secondary">‚¨Ö GO HOME</button>
      </div>
    </div>
  </div>

  <!-- Game elements -->
  <canvas id="gameCanvas"></canvas>
  <div id="rocketGif">
    <img id="rocketGifImg" src="assets/rocket.gif" style="width:100%; height:100%; display:none;">
  </div>
  <!-- NYAN Cat GIF container -->
  <img id="nyanCatGif" src="assets/nyancat.gif">

  <button id="pauseBtn" class="btn">‚è∏ PAUSE</button>

  <!-- Leaderboard screen -->
  <div id="leaderboardScreen" class="screen">
    <div id="boardCard">
      <div style="display:flex; align-items:center; justify-content:space-between; padding: 0 6px 6px;">
        <h2 style="margin:6px 0 0; font-size:18px">üèÜ Leaderboard (Total Coin)</h2>
        <span id="entriesMeta" class="pill">‚Äî</span>
      </div>
      <div style="overflow:auto; max-height: 60vh;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Coins</th> <!-- Changed from Coin (Total) -->
              <th>NYAN Coins</th> <!-- Added NYAN Coins column -->
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
      <div class="footerRow">
        <button id="backHome" class="btn ghost">‚¨Ö Home</button>
        <button id="playAgain" class="btn">üîÑ Play Again</button>
      </div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="bgMusic" src="assets/bgmusic.mp3" loop preload="auto"></audio>
  <audio id="popSound" src="assets/popsound.mp3" preload="auto"></audio>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, child, runTransaction }
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.appspot.com",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ===== Game State ===== */
    const state = {
      currentSkin: 'default',
      unlockedSkins: ['default'],
      skins: {
        default: {
          name: 'Default Rocket',
          price: 0,
          unlocked: true,
          gif: 'assets/rocket.gif',
          png: 'assets/rocket.png'
        },
        fire: {
          name: 'Flame Rocket',
          price: 500,
          unlocked: false,
          gif: 'assets/rocket_fire.gif',
          png: 'assets/rocket_fire.png'
        },
        ice: {
          name: 'Ice Rocket',
          price: 750,
          unlocked: false,
          gif: 'assets/rocket_ice.gif',
          png: 'assets/rocket_ice.png'
        },
        rainbow: {
          name: 'Rainbow Rocket',
          price: { type: 'nyan', value: 100 }, // Changed to NYAN coin price
          unlocked: false,
          gif: 'assets/rocket_rainbow.gif',
          png: 'assets/rocket_rainbow.png'
        },
        galaxy: {
          name: 'Galaxy Rocket',
          price: 1500,
          unlocked: false,
          gif: 'assets/rocket_galaxy.gif',
          png: 'assets/rocket_galaxy.png'
        }
      }
    };

    /* ===== Telegram user ===== */
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    let currentUser = "guest";
    let currentUserId = "guest_id";
    let photoUrl = "";
    let userTotalCoins = 0;
    let userNyanCoins = 0; // Track total NYAN coins for the user

    const user = tg?.initDataUnsafe?.user;
    if (user) {
      currentUserId = user.id.toString();
      currentUser = user.username || [user.first_name, user.last_name].filter(Boolean).join(" ");
      photoUrl = user.photo_url || "";
    }

    const userInfo = document.getElementById("userInfo");
    const userNameEl = document.getElementById("userName");
    const userPhotoEl = document.getElementById("userPhoto");
    const userCoinsEl = document.getElementById("userCoins");
    const nyanCoinsDisplayEl = document.getElementById("nyanCoinsDisplay"); // New element for NYAN coins in inventory

    function showUserBadge(show) {
      userInfo.style.display = show ? "flex" : "none";
    }

    async function updateUserInfoDisplay() {
      userNameEl.textContent = currentUser;
      if (photoUrl) userPhotoEl.src = photoUrl;

      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
          const existingData = snapshot.val();
          userTotalCoins = existingData.totalCoins || 0;
          userNyanCoins = existingData.nyanCoins || 0; // Retrieve NYAN coins
          if (existingData.unlockedSkins) {
            state.unlockedSkins = existingData.unlockedSkins;
            state.currentSkin = existingData.currentSkin || 'default';
          }

          // Only update Firebase if user data has changed or if it's a new user
          // This prevents unnecessary writes on every page load if data is identical
          if (existingData.username !== currentUser || existingData.photo_url !== photoUrl ||
              !existingData.unlockedSkins || !existingData.currentSkin || existingData.nyanCoins === undefined) { // Check if new fields exist
            await update(userRef, {
              username: currentUser,
              photo_url: photoUrl,
              unlockedSkins: state.unlockedSkins,
              currentSkin: state.currentSkin,
              nyanCoins: userNyanCoins // Ensure NYAN coins are updated if other user data changes
            });
          }
        } else {
          userTotalCoins = 0;
          userNyanCoins = 0; // Initialize NYAN coins for new users
          await set(userRef, {
            username: currentUser,
            photo_url: photoUrl,
            totalCoins: 0,
            nyanCoins: 0, // Store NYAN coins
            unlockedSkins: state.unlockedSkins,
            currentSkin: state.currentSkin,
            createdAt: new Date().toISOString()
          });
        }
        userCoinsEl.textContent = `ü™ô ${userTotalCoins}`;
      } else {
        userTotalCoins = 0;
        userNyanCoins = 0; // Reset for guest
        userCoinsEl.textContent = `(Guest)`;
      }

      document.getElementById('coinsDisplay').textContent = `COINS: ${userTotalCoins}`;
      nyanCoinsDisplayEl.textContent = `NYAN COINS: ${userNyanCoins}`; // Update NYAN coins display in inventory
      const skinData = state.skins[state.currentSkin];
      rocketImg.src = skinData.png;
      gifElement.src = skinData.gif;
    }

    /* ===== Canvas / Game ===== */
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const rocketGif = document.getElementById("rocketGif");
    const gifElement = document.getElementById("rocketGifImg");
    const nyanCatGif = document.getElementById("nyanCatGif"); // Get the NYAN Cat GIF element
    const pauseBtn = document.getElementById("pauseBtn");
    const pauseScreen = document.getElementById("pauseScreen");
    const resumeGame = document.getElementById("resumeGame");
    const goHomeFromPause = document.getElementById("goHomeFromPause");

    // Preload images
    const rocketImg = new Image();
    rocketImg.src = state.skins[state.currentSkin].png;
    const obstacleImg = new Image();
    obstacleImg.src = "assets/obstacle.png";
    const coinImg = new Image();
    coinImg.src = "assets/coin.png";
    const nyanCoinImg = new Image(); // Added for NYAN coin icon (invisible in game, but used for collision)
    nyanCoinImg.src = "assets/nyancoin.png";

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // Audio elements
    const bgMusic = document.getElementById('bgMusic');
    bgMusic.volume = 0.3;
    const popSound = document.getElementById('popSound');
    popSound.volume = 0.7;
    const coinCollectSound = new Audio('assets/coincollect.mp3');
    coinCollectSound.volume = 0.5;

    // Rocket properties
    let rocket = {
      x: window.innerWidth/2 - 50,
      y: window.innerHeight - 200,
      w: 100,
      h: 100,
      targetX: window.innerWidth/2 - 50,
      speed: 0.15,
      rotation: 0,
      targetRotation: 0,
      rotationSpeed: 0.1,
      collisionOffsetX: 25,
      collisionOffsetY: 10,
      collisionWidthShrink: 50,
      collisionHeightShrink: 20
    };

    // Star animation
    let stars = [];
    function spawnStar() {
      stars.push({
        x: Math.random() * canvas.width,
        y: -5,
        radius: Math.random() * 2 + 1,
        vy: Math.random() * 2 + 2
      });
    }

    // Game state
    let running = false, score = 0; // Regular coins collected in current game
    let nyanScore = 0; // NYAN coins collected in current game
    let coinsCollectedSinceLastNyan = 0; // Counter for normal coins to trigger NYAN
    let obstacles = [], coins = [];
    let touchStartX = null;

    const ROTATION_ANGLE_RAD = 10 * Math.PI / 180;

    // Touch controls
    canvas.addEventListener("touchstart", e => {
      touchStartX = e.touches[0].clientX;
      rocket.targetX = Math.max(0, Math.min(e.touches[0].clientX - rocket.w / 2, window.innerWidth - rocket.w));
    }, { passive: true });

    canvas.addEventListener("touchmove", e => {
      const currentTouchX = e.touches[0].clientX;
      const newTargetX = Math.max(0, Math.min(currentTouchX - rocket.w / 2, window.innerWidth - rocket.w));

      if (newTargetX < rocket.x) {
        rocket.targetRotation = -ROTATION_ANGLE_RAD;
      } else if (newTargetX > rocket.x) {
        rocket.targetRotation = ROTATION_ANGLE_RAD;
      } else {
        rocket.targetRotation = 0;
      }

      rocket.targetX = newTargetX;
    }, { passive: true });

    canvas.addEventListener("touchend", e => {
      if (touchStartX == null) return;
      const finalTouchX = e.changedTouches[0].clientX;
      rocket.targetX = Math.max(0, Math.min(finalTouchX - rocket.w / 2, window.innerWidth - rocket.w));
      rocket.targetRotation = 0;
      touchStartX = null;
    });

    // Game objects spawn
    function spawnObstacle() {
      const size = 72;
      const obstacleCollisionPadding = 18;
      obstacles.push({
        x: Math.random() * (window.innerWidth - size),
        y: -size,
        w: size,
        h: size,
        vy: 3,
        rotation: 0,
        rotationSpeed: (Math.random() - 0.5) * 0.05,
        collisionPadding: obstacleCollisionPadding
      });
    }

    function spawnCoin() {
      const size = 44; // Collision size for the invisible NYAN coin
      const nyanCatWidth = nyanCatGif.offsetWidth; // Actual width of the GIF
      const nyanCatHeight = nyanCatGif.offsetHeight; // Actual height of the GIF

      const isNyanCoin = (coinsCollectedSinceLastNyan >= 50); // Check if it's time for a NYAN coin

      let coinType = 'normal';
      let coinImage = coinImg;
      let vx = 0; // Horizontal velocity for NYAN coin

      if (isNyanCoin) {
        coinType = 'nyan';
        coinImage = nyanCoinImg; // Still use for collision detection
        coinsCollectedSinceLastNyan = 0; // Reset counter after spawning NYAN

        // Determine starting side and direction for NYAN cat
        if (Math.random() < 0.5) { // Start from left
            vx = 2; // Move right
            // Start off-screen left, adjust for nyanCatGif's width
            coins.push({
                x: -nyanCatWidth, // Start fully off-screen
                y: Math.random() * (window.innerHeight / 2), // Spawn higher up
                w: size, // Collision width
                h: size, // Collision height
                vy: 1, // Slower vertical movement
                vx: vx,
                alpha: 1,
                collected: false,
                type: coinType,
                image: coinImage
            });
        } else { // Start from right
            vx = -2; // Move left
            // Start off-screen right, adjust for nyanCatGif's width
            coins.push({
                x: window.innerWidth, // Start fully off-screen
                y: Math.random() * (window.innerHeight / 2), // Spawn higher up
                w: size, // Collision width
                h: size, // Collision height
                vy: 1, // Slower vertical movement
                vx: vx,
                alpha: 1,
                collected: false,
                type: coinType,
                image: coinImage
            });
        }
        return; // Exit, as NYAN coin is already pushed
      }

      // Normal coin spawn
      coins.push({
        x: Math.random() * (window.innerWidth - size),
        y: -size,
        w: size,
        h: size,
        vy: 3,
        vx: 0, // Normal coins don't move horizontally
        alpha: 1,
        collected: false,
        type: coinType,
        image: coinImage
      });
    }

    // Main game loop
    function loop(t) {
      if (!running) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Spawn stars
      if (Math.random() < 0.1) spawnStar();

      // Draw and update stars (background)
      ctx.fillStyle = "#ffffff";
      for (const star of stars) {
        star.y += star.vy;
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
      }
      stars = stars.filter(star => star.y < canvas.height + star.radius);

      // Update rocket position
      rocket.x += (rocket.targetX - rocket.x) * rocket.speed;
      rocket.rotation += (rocket.targetRotation - rocket.rotation) * rocket.rotationSpeed;

      // Update animated GIF position
      rocketGif.style.left = rocket.x + 'px';
      rocketGif.style.top = rocket.y + 'px';
      rocketGif.style.transform = `rotate(${rocket.rotation}rad)`;

      // Spawn objects
      if (Math.random() < 0.008) spawnObstacle();
      if (Math.random() < 0.02) spawnCoin();

      // Draw and update coins
      let nyanCoinActive = false; // Flag to track if a NYAN coin is currently on screen
      for (const c of coins) {
        if (!c.collected) {
          c.y += c.vy;
          c.x += c.vx; // Apply horizontal velocity
        } else {
          c.alpha -= 0.05;
          if (c.alpha < 0) c.alpha = 0;
        }

        // Only draw normal coins on canvas
        if (c.type === 'normal' && c.image.complete && c.alpha > 0) {
          ctx.save();
          ctx.globalAlpha = c.alpha;
          ctx.drawImage(c.image, c.x, c.y, c.w, c.h);
          ctx.restore();
        } else if (c.type === 'nyan' && !c.collected) {
            // Position NYAN Cat GIF to follow the invisible NYAN coin's center
            // Adjust for nyanCatGif's actual dimensions to center it on the collision box
            nyanCatGif.style.display = 'block';
            nyanCatGif.style.left = `${c.x + (c.w / 2) - (nyanCatGif.offsetWidth / 2)}px`;
            nyanCatGif.style.top = `${c.y + (c.h / 2) - (nyanCatGif.offsetHeight / 2)}px`;
            nyanCatGif.style.opacity = 1; // Ensure it's visible
            nyanCatGif.classList.remove('collecting'); // Remove collecting class if not collecting
            nyanCoinActive = true;
        }
      }
      // If no NYAN coin is active, hide the GIF (unless it's currently animating a collection)
      if (!nyanCoinActive && !nyanCatGif.classList.contains('collecting')) {
          nyanCatGif.style.display = 'none';
      }

      // Filter out coins that are off-screen or fully faded
      coins = coins.filter(c =>
          (c.y < window.innerHeight + c.h + 22 && c.alpha > 0) &&
          (c.type === 'normal' || (c.type === 'nyan' && c.x > -nyanCatGif.offsetWidth && c.x < window.innerWidth + nyanCatGif.offsetWidth))
      );


      // Draw rocket.png on canvas
      if (rocketImg.complete) {
        ctx.save();
        ctx.globalAlpha = 1;
        ctx.translate(rocket.x + rocket.w / 2, rocket.y + rocket.h / 2);
        ctx.rotate(rocket.rotation);
        ctx.drawImage(rocketImg, -rocket.w / 2, -rocket.h / 2, rocket.w, rocket.h);
        ctx.restore();
      }

      // Collision detection
      for (const o of obstacles) { if (hit(rocket, o)) { return endGame(); } }
      for (let i = coins.length - 1; i >= 0; i--) {
        if (!coins[i].collected && hit(rocket, coins[i])) {
          if (coins[i].type === 'normal') {
            score++;
            coinsCollectedSinceLastNyan++; // Increment counter for normal coins
          } else if (coins[i].type === 'nyan') {
            nyanScore++; // Increment NYAN coin score
            // Trigger NYAN Cat GIF collect animation
            nyanCatGif.classList.add('collecting');
            setTimeout(() => {
                nyanCatGif.style.display = 'none';
                nyanCatGif.classList.remove('collecting');
                nyanCatGif.style.opacity = 1; // Reset opacity for next time
                nyanCatGif.style.transform = 'scale(1)'; // Reset scale for next time
            }, 100); // Animation duration (matches CSS transition)
          }
          coins[i].collected = true;
          const playSound = new Audio('assets/coincollect.mp3');
          playSound.volume = 0.5;
          playSound.play().catch(e => console.error("Error playing sound:", e));
        }
      }

      // Draw HUD
      ctx.fillStyle = "#eaf2ff";
      ctx.font = "20px 'Press Start 2P'";

      // Draw regular coin icon and score
      if (coinImg.complete) {
        ctx.drawImage(coinImg, 12, 8, 20, 20); // Adjust position and size as needed
      }
      ctx.fillText(": " + score, 38, 28); // Adjust text position

      // Draw NYAN coin icon and score
      if (nyanCoinImg.complete) {
        ctx.drawImage(nyanCoinImg, 12, 38, 20, 20); // Adjust position and size
      }
      ctx.fillText(": " + nyanScore, 38, 58); // Adjust text position

      requestAnimationFrame(loop);
    }

    // Collision detection
    function hit(a, b) {
      const aX = a.x + a.collisionOffsetX;
      const aY = a.y + a.collisionOffsetY;
      const aW = a.w - a.collisionWidthShrink;
      const aH = a.h - a.collisionHeightShrink;

      const bPadding = b.collisionPadding !== undefined ? b.collisionPadding : 0;
      const bX = b.x + bPadding;
      const bY = b.y + bPadding;
      const bW = b.w - (bPadding * 2);
      const bH = b.h - (bPadding * 2);

      return aX < bX + bW && aX + aW > bX && aY < bY + bH && aY + aH > bY;
    }

    /* ===== Screens & Leaderboard ===== */
    const homeScreen = document.getElementById("homeScreen");
    const boardScreen = document.getElementById("leaderboardScreen");
    const inventoryScreen = document.getElementById("inventoryScreen");
    const startBtn = document.getElementById("startBtn");
    const openBoardBtn = document.getElementById("openBoardBtn");
    const openInventoryBtn = document.getElementById("openInventoryBtn");
    const backFromInventory = document.getElementById("backFromInventory");
    const backHome = document.getElementById("backHome");
    const playAgain = document.getElementById("playAgain");
    const tbody = document.getElementById("leaderboardBody");
    const entriesMeta = document.getElementById("entriesMeta");

    // Button sound effects
    const allButtons = document.querySelectorAll('.btn');
    allButtons.forEach(button => {
      button.addEventListener('click', () => {
        popSound.currentTime = 0;
        popSound.play().catch(e => console.error("Error playing pop sound:", e));
      });
    });

    // Game controls
    startBtn.addEventListener("click", () => {
      showUserBadge(false);
      homeScreen.style.display = "none";
      boardScreen.style.display = "none";
      inventoryScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "block";
      score = 0;
      nyanScore = 0; // Reset NYAN score for new game
      coinsCollectedSinceLastNyan = 0; // Reset NYAN counter for new game
      obstacles = [];
      coins = [];
      stars = [];
      rocket.x = window.innerWidth/2 - rocket.w/2;
      rocket.targetX = rocket.x;
      rocket.y = window.innerHeight - 200;
      rocket.rotation = 0;
      rocket.targetRotation = 0;
      running = true;

      // Ensure correct skin is loaded
      const skinData = state.skins[state.currentSkin];
      rocketImg.src = skinData.png;
      gifElement.src = skinData.gif;
      gifElement.style.display = 'block';
      nyanCatGif.style.display = 'none'; // Ensure NYAN cat is hidden at start of game
      nyanCatGif.classList.remove('collecting'); // Clear any lingering animation classes
      nyanCatGif.style.opacity = 1; // Reset opacity
      nyanCatGif.style.transform = 'scale(1)'; // Reset scale

      bgMusic.play().catch(e => console.error("Error playing background music:", e));
      requestAnimationFrame(loop);
    });

    pauseBtn.addEventListener("click", () => {
      running = false;
      bgMusic.pause();
      pauseScreen.style.display = "flex";
      pauseBtn.style.display = "none";
      rocketGif.style.display = "none";
      nyanCatGif.style.display = 'none'; // Hide NYAN cat if paused
    });

    resumeGame.addEventListener("click", () => {
      running = true;
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "block";
      rocketGif.style.display = "block";
      // nyanCatGif will be shown by the game loop if a NYAN coin is present
      bgMusic.play().catch(e => console.error("Error playing background music:", e));
      requestAnimationFrame(loop);
    });

    goHomeFromPause.addEventListener("click", () => {
      running = false;
      pauseScreen.style.display = "none";
      homeScreen.style.display = "flex";
      boardScreen.style.display = "none";
      inventoryScreen.style.display = "none";
      pauseBtn.style.display = "none";
      rocketGif.style.display = "none";
      nyanCatGif.style.display = 'none'; // Hide NYAN cat when going home
      bgMusic.pause();
      bgMusic.currentTime = 0;
      showUserBadge(true);
    });

    openBoardBtn.addEventListener("click", async () => {
      await showLeaderboard();
      boardScreen.style.display = "flex";
      homeScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "none";
      showUserBadge(true);
    });

    backFromInventory.addEventListener("click", () => {
      homeScreen.style.display = "flex";
      boardScreen.style.display = "none";
      inventoryScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "none";
      showUserBadge(true);
    });

    backHome.addEventListener("click", () => {
      homeScreen.style.display = "flex";
      boardScreen.style.display = "none";
      inventoryScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "none";
      showUserBadge(true);
    });

    playAgain.addEventListener("click", () => {
      boardScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "block";
      showUserBadge(false);
      startBtn.click();
    });

    // Inventory system
    function populateInventory() {
      const skinGrid = document.getElementById('skinGrid');
      skinGrid.innerHTML = '';

      Object.entries(state.skins).forEach(([skinId, skinData]) => {
        const isUnlocked = state.unlockedSkins.includes(skinId);
        const isEquipped = state.currentSkin === skinId;

        const skinCard = document.createElement('div');
        skinCard.className = `skin-card ${isEquipped ? 'equipped' : ''} ${!isUnlocked ? 'locked' : ''}`;

        let priceText = '';
        if (!isUnlocked) {
            if (typeof skinData.price === 'object' && skinData.price.type === 'nyan') {
                priceText = `<span class="price"> (${skinData.price.value} NYAN)</span>`;
            } else {
                priceText = `<span class="price"> (${skinData.price})</span>`;
            }
        }

        skinCard.innerHTML = `
          <div class="skin-preview">
            <img src="${skinData.gif || skinData.png}" alt="${skinData.name} rocket skin preview" />
          </div>
          <div class="skin-name">${skinData.name}${priceText}</div>
        `;

        if (isUnlocked) {
          skinCard.addEventListener('click', () => equipSkin(skinId));
        } else {
          skinCard.addEventListener('click', () => attemptUnlockSkin(skinId, skinData.price));
        }

        skinGrid.appendChild(skinCard);
      });
    }

    function equipSkin(skinId) {
      if (!state.unlockedSkins.includes(skinId)) return;

      state.currentSkin = skinId;
      const skinData = state.skins[skinId];

      // Update rocket images
      rocketImg.src = skinData.png;
      gifElement.src = skinData.gif;

      // Update UI
      populateInventory();

      // Save to Firebase if logged in
      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        update(userRef, { currentSkin: skinId });
      }
    }

    function attemptUnlockSkin(skinId, price) {
      let canAfford = false;
      let costType = 'normal';
      let costValue = price;

      if (typeof price === 'object' && price.type === 'nyan') {
          costType = 'nyan';
          costValue = price.value;
          if (userNyanCoins >= costValue) {
              canAfford = true;
          }
      } else { // Normal coin price
          if (userTotalCoins >= costValue) {
              canAfford = true;
          }
      }

      if (!canAfford) {
        alert(`You need ${costValue} ${costType === 'nyan' ? 'NYAN coins' : 'coins'} to unlock this skin!`);
        return;
      }

      if (costType === 'nyan') {
          userNyanCoins -= costValue;
      } else {
          userTotalCoins -= costValue;
      }

      state.unlockedSkins.push(skinId);

      // Update UI
      updateUserInfoDisplay(); // This will refresh userTotalCoins and userNyanCoins display
      populateInventory();

      // Save to Firebase if logged in
      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        const updateData = { unlockedSkins: state.unlockedSkins };
        if (costType === 'nyan') {
            updateData.nyanCoins = userNyanCoins;
        } else {
            updateData.totalCoins = userTotalCoins;
        }
        update(userRef, updateData);
      }

      // Equip the new skin automatically
      equipSkin(skinId);
    }

    // Game over handler
    async function endGame() {
      running = false;
      gifElement.style.display = 'none';
      nyanCatGif.style.display = 'none'; // Hide NYAN cat when game ends
      nyanCatGif.classList.remove('collecting'); // Clear any lingering animation classes
      nyanCatGif.style.opacity = 1; // Reset opacity
      nyanCatGif.style.transform = 'scale(1)'; // Reset scale
      pauseBtn.style.display = "none";
      bgMusic.pause();
      bgMusic.currentTime = 0;

      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        await runTransaction(userRef, (currentData) => {
          if (currentData) {
            currentData.totalCoins = (currentData.totalCoins || 0) + score; // Add current game's regular coins
            currentData.nyanCoins = (currentData.nyanCoins || 0) + nyanScore; // Add current game's NYAN coins
          } else {
            currentData = {
              username: currentUser,
              photo_url: photoUrl,
              totalCoins: score,
              nyanCoins: nyanScore,
              unlockedSkins: state.unlockedSkins, // Corrected typo here
              currentSkin: state.currentSkin,
              createdAt: new Date().toISOString()
            };
          }
          return currentData;
        });
        await updateUserInfoDisplay(); // Refresh user badge with updated total coins
      }

      await showLeaderboard();
      boardScreen.style.display = "flex";
      pauseScreen.style.display = "none";
      showUserBadge(true);
    }

    // Leaderboard functions
    async function showLeaderboard() {
      tbody.innerHTML = `<tr><td colspan="4" style="padding:16px; color:#cfe1ff">Loading...</td></tr>`; // Adjusted colspan
      const usersRef = ref(db, "users");
      const snapshot = await get(usersRef);

      if (!snapshot.exists()) {
        tbody.innerHTML = `<tr><td colspan="4" style="padding:16px; color:#cfe1ff">No players yet.</td></tr>`; // Adjusted colspan
        entriesMeta.textContent = "0 players";
        return;
      }

      const usersList = Object.values(snapshot.val());
      const sortedUsers = usersList
        .filter(u => u.totalCoins !== undefined || u.nyanCoins !== undefined) // Filter users with any coin data
        .sort((a, b) => {
            // Sort primarily by totalCoins, then by nyanCoins if totalCoins are equal
            const totalA = a.totalCoins || 0;
            const totalB = b.totalCoins || 0;
            const nyanA = a.nyanCoins || 0;
            const nyanB = b.nyanCoins || 0;

            if (totalB !== totalA) {
                return totalB - totalA;
            }
            return nyanB - nyanA;
        });

      tbody.innerHTML = "";
      sortedUsers.forEach((u, idx) => {
        const tr = document.createElement("tr");
        if (idx === 0) tr.classList.add("top1");
        else if (idx === 1) tr.classList.add("top2");
        else if (idx === 2) tr.classList.add("top3");
        tr.innerHTML = `
          <td class="rank">${idx + 1}</td>
          <td>${u.username}</td>
          <td class="score">${u.totalCoins || 0}</td>
          <td class="score">${u.nyanCoins || 0}</td>
        `;
        tbody.appendChild(tr);
      });
      entriesMeta.textContent = `${sortedUsers.length} players`;
    }

    // Initialize
    openInventoryBtn.addEventListener("click", () => {
      populateInventory();
      inventoryScreen.style.display = "flex";
      homeScreen.style.display = "none";
      boardScreen.style.display = "none";
      pauseScreen.style.display = "none";
      pauseBtn.style.display = "none";
      showUserBadge(true);
    });

    updateUserInfoDisplay();
    showUserBadge(true);
  </script>
</body>
</html>
