<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game with Leaderboard</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: Arial; overflow: hidden; }
    #gameCanvas { display: block; width: 100%; height: 80vh; background: black; }
    #homeScreen, #leaderboardScreen {
      position: absolute; top:0; left:0; right:0; bottom:0;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.9);
    }
    #leaderboardScreen { display: none; }
    #startBtn { padding: 10px 20px; background: gold; border:none; border-radius:10px; font-size:20px; cursor:pointer; }
    table { width:90%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #444; padding:5px; text-align:center; }
    th { background:#222; }
    button { margin:2px; padding:5px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Home screen -->
  <div id="homeScreen">
    <h1>üöÄ Space Rocket</h1>
    <input type="text" id="usernameInput" placeholder="–¢–∞–Ω—ã –Ω—ç—Ä">
    <button id="startBtn" disabled>Start Game</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Leaderboard -->
  <div id="leaderboardScreen">
    <h2>üèÜ Leaderboard</h2>
    <table>
      <thead>
        <tr><th>–ù—ç—Ä</th><th>–û–Ω–æ–æ</th><th>–û–Ω —Å–∞—Ä</th><th id="adminCol"></th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button onclick="restart()">üîÑ –î–∞—Ö–∏–Ω —Ç–æ–≥–ª–æ—Ö</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child, remove, update, query, orderByChild, limitToLast } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"; // Authentication –Ω—ç–º—Å—ç–Ω

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.firebasestorage.app",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42",
      measurementId: "G-94EH113TS5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); // Authentication-–≥ —ç–Ω–¥—ç—ç—Å –∞–≤–Ω–∞

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Canvas-–∏–π–Ω —Ö—ç–º–∂—ç—ç–≥ –¥–∏–Ω–∞–º–∏–∫–∞–∞—Ä —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight * 0.8;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // UI
    const homeScreen = document.getElementById("homeScreen");
    const leaderboardScreen = document.getElementById("leaderboardScreen");
    const startBtn = document.getElementById("startBtn");
    const usernameInput = document.getElementById("usernameInput");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const adminCol = document.getElementById("adminCol");

    let currentUser = "";
    let score = 0;
    let rocket = { x: canvas.width/2-25, y: canvas.height-100, width:50, height:50 };
    let obstacles = [];
    let coins = [];
    let running = false;
    let gameSpeed = 1; // –¢–æ–≥–ª–æ–æ–º—ã–Ω —Ö—É—Ä–¥—ã–≥ –Ω—ç–º—ç—Ö
    let lastObstacleTime = 0;
    let lastCoinTime = 0;
    const obstacleInterval = 2000; // 2 —Å–µ–∫—É–Ω–¥ —Ç—É—Ç–∞–º–¥ —Å–∞–∞–¥
    const coinInterval = 3000; // 3 —Å–µ–∫—É–Ω–¥ —Ç—É—Ç–∞–º–¥ –∑–æ–æ—Å
    let isAdmin = false; // –ê–¥–º–∏–Ω—ã —Å—Ç–∞—Ç—É—Å

    // Assets
    const rocketImg = new Image(); rocketImg.src = "assets/rocket.gif";
    const obstacleImg = new Image(); obstacleImg.src = "assets/obstacle.gif";
    const coinImg = new Image(); coinImg.src = "assets/coin.png";

    // –ó—É—Ä–≥—É—É–¥—ã–≥ –∞—á–∞–∞–ª—Å–Ω—ã –¥–∞—Ä–∞–∞ —Ç–æ–≥–ª–æ–æ–º—ã–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö
    let imagesLoaded = 0;
    const totalImages = 3;
    function imageLoaded() {
      imagesLoaded++;
      if (imagesLoaded === totalImages) {
        startBtn.disabled = false;
      }
    }
    rocketImg.onload = imageLoaded;
    obstacleImg.onload = imageLoaded;
    coinImg.onload = imageLoaded;

    // –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –Ω—ç—Ä–∏–π–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö
    function sanitizeInput(input) {
      return input.replace(/[<>&"]/g, "").substring(0, 20); // HTML —Ç—ç–º–¥—ç–≥—Ç —É—Å—Ç–≥–∞–∂, 20 —Ç—ç–º–¥—ç–≥—Ç—ç—ç—Ä —Ö—è–∑–≥–∞–∞—Ä–ª–∞–Ω–∞
    }

    // Swipe control
    let touchStartX = null;
    canvas.addEventListener("touchstart", e => { touchStartX = e.touches[0].clientX; });
    canvas.addEventListener("touchend", e => {
      if (!touchStartX) return;
      let dx = e.changedTouches[0].clientX - touchStartX;
      if (dx > 50) rocket.x = Math.min(canvas.width - rocket.width, rocket.x + 50);
      if (dx < -50) rocket.x = Math.max(0, rocket.x - 50);
      touchStartX = null;
    });

    // Start game
    startBtn.onclick = () => {
      currentUser = sanitizeInput(usernameInput.value.trim());
      if (!currentUser) { alert("–ù—ç—Ä—ç—ç –æ—Ä—É—É–ª!"); return; }
      homeScreen.style.display = "none";
      score = 0; obstacles = []; coins = [];
      gameSpeed = 1; // –•—É—Ä–¥—ã–≥ —ç—Ö–Ω–∏–π —É—Ç–≥–∞–¥–∞–∞ –±—É—Ü–∞–∞–Ω–∞
      rocket.x = canvas.width / 2 - 25;
      rocket.y = canvas.height - 100;
      running = true;
      requestAnimationFrame(loop);
    };

    function spawnObstacle() {
      obstacles.push({ x: Math.random() * (canvas.width - 40), y: -40, w: 40, h: 40 });
    }
    function spawnCoin() {
      coins.push({ x: Math.random() * (canvas.width - 20), y: -20, w: 20, h: 20 });
    }

    function loop(timestamp) {
      if (!running) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw rocket
      ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.width, rocket.height);

      // Obstacles
      if (timestamp - lastObstacleTime > obstacleInterval && Math.random() < 0.02) {
        spawnObstacle();
        lastObstacleTime = timestamp;
      }
      obstacles.forEach(o => { o.y += 3 * gameSpeed; ctx.drawImage(obstacleImg, o.x, o.y, o.w, o.h); });
      obstacles = obstacles.filter(o => o.y < canvas.height);

      // Coins
      if (timestamp - lastCoinTime > coinInterval && Math.random() < 0.02) {
        spawnCoin();
        lastCoinTime = timestamp;
      }
      coins.forEach(c => { c.y += 2 * gameSpeed; ctx.drawImage(coinImg, c.x, c.y, c.w, c.h); });
      coins = coins.filter(c => c.y < canvas.height);

      // Collisions
      for (let o of obstacles) {
        if (collision(rocket, o)) { endGame(); return; }
      }
      for (let i = coins.length - 1; i >= 0; i--) {
        if (collision(rocket, coins[i])) {
          score++;
          coins.splice(i, 1);
          if (score % 10 === 0) gameSpeed += 0.1; // 10 –æ–Ω–æ–æ –±“Ø—Ä—Ç —Ö—É—Ä–¥ –Ω—ç–º—ç–≥–¥—ç–Ω—ç
        }
      }

      // Score text
      ctx.fillStyle = "white";
      ctx.font = "bold 24px Arial"; // –§–æ–Ω—Ç—ã–≥ —Ç–æ–¥ –±–æ–ª–≥–æ—Å–æ–Ω
      ctx.fillText("–û–Ω–æ–æ: " + score, 10, 30);

      requestAnimationFrame(loop);
    }

    function collision(a, b) {
      return a.x < b.x + b.w &&
             a.x + a.width > b.x &&
             a.y < b.y + b.h &&
             a.y + a.height > b.y;
    }

    async function endGame() {
      running = false;
      // Save high score to localStorage
      const highScore = localStorage.getItem("highScore") || 0;
      if (score > highScore) {
        localStorage.setItem("highScore", score);
        alert("–®–∏–Ω—ç –¥—ç—ç–¥ –∞–º–∂–∏–ª—Ç: " + score);
      }
      // Save score to Firebase
      const scoresRef = ref(db, "scores");
      const newRef = push(scoresRef);
      await set(newRef, { username: currentUser, score, createdAt: new Date().toISOString() });
      // Show leaderboard
      showLeaderboard();
    }

    async function showLeaderboard() {
      leaderboardScreen.style.display = "flex";
      leaderboardBody.innerHTML = "";
      const scoresQuery = query(ref(db, "scores"), orderByChild("score"), limitToLast(10));
      const snapshot = await get(scoresQuery);
      if (snapshot.exists()) {
        let data = Object.entries(snapshot.val()).map(([id, val]) => ({ id, ...val }));
        data.sort((a, b) => b.score - a.score);
        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${sanitizeInput(row.username)}</td><td>${row.score}</td><td>${new Date(row.createdAt).toLocaleString()}</td>`;
          if (isAdmin) {
            const td = document.createElement("td");
            td.innerHTML = `<button onclick="updateScore('${row.id}')">Edit</button>
                            <button onclick="deleteScore('${row.id}')">Delete</button>`;
            tr.appendChild(td);
          }
          leaderboardBody.appendChild(tr);
        });
        if (isAdmin) adminCol.textContent = "Admin";
      }
    }

    window.deleteScore = async (id) => {
      if (isAdmin) {
        await remove(ref(db, "scores/" + id));
        showLeaderboard();
      }
    };
    window.updateScore = async (id) => {
      if (isAdmin) {
        const newScore = prompt("–®–∏–Ω—ç –æ–Ω–æ–æ:");
        if (newScore) {
          await update(ref(db, "scores/" + id), { score: parseInt(newScore) });
          showLeaderboard();
        }
      }
    };

    window.restart = () => {
      leaderboardScreen.style.display = "none";
      homeScreen.style.display = "flex";
    };

    // –ê–¥–º–∏–Ω—ã —ç—Ä—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö (–ñ–∏—à—ç—ç, —Ç–∞ ”©”©—Ä–∏–π–Ω –Ω—ç–≤—Ç—Ä—ç–ª—Ç–∏–π–Ω —Å–∏—Å—Ç–µ–º–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω–∞ —É—É)
    // async function checkAdmin() {
    //   try {
    //     const userCredential = await signInWithEmailAndPassword(auth, "admin@example.com", "adminPassword");
    //     isAdmin = true;
    //   } catch (error) {
    //     isAdmin = false;
    //   }
    // }
    // checkAdmin(); // –ù—ç–≤—Ç—Ä—ç–ª—Ç–∏–π–≥ –¥—É—É–¥–∞—Ö (—Ç–∞ ”©”©—Ä–∏–π–Ω UI-–≥—ç—ç—Ä —Å–æ–ª—å–∂ –±–æ–ª–Ω–æ)
  </script>
</body>
</html>