<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    let gameRunning = false;

    const stars = Array.from({ length: 100 }, () => ({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      size: Math.random() * 2,
      speed: 0.5 + Math.random() * 1.5
    }));

    const rocketImg = new Image();
    rocketImg.src = "assets/rocket.gif";
    const obstacleImg = new Image();
    obstacleImg.src = "assets/obstacle.gif";
    const coinImg = new Image();
    coinImg.src = "assets/coin.png";

    let assetsLoaded = 0;
    const totalAssets = 3;
    function assetLoaded() {
      assetsLoaded++;
      if (assetsLoaded === totalAssets) {
        document.getElementById("startBtn").disabled = false;
      }
    }
    rocketImg.onload = assetLoaded;
    obstacleImg.onload = assetLoaded;
    coinImg.onload = assetLoaded;

    let rocket = { x: window.innerWidth / 2 - 25, y: window.innerHeight - 100, width: 50, height: 50 };
    let obstacles = [];
    let coins = [];
    let score = 0;
    let lastObstacleSpawn = 0;
    let lastCoinSpawn = 0;

    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("homeScreen").style.display = "none";
      startGame();
    });

    // Swipe control
    let touchStartX = 0;
    let touchEndX = 0;
    canvas.addEventListener("touchstart", e => {
      touchStartX = e.changedTouches[0].screenX;
    });
    canvas.addEventListener("touchend", e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });
    function handleSwipe() {
      const swipeDistance = touchEndX - touchStartX;
      if (Math.abs(swipeDistance) > 30) {
        if (swipeDistance > 0) {
          rocket.x += 40; // swipe right
        } else {
          rocket.x -= 40; // swipe left
        }
      }
    }

    // Keyboard for testing
    document.addEventListener("keydown", e => {
      if (e.code === "ArrowLeft") rocket.x -= 20;
      if (e.code === "ArrowRight") rocket.x += 20;
    });

    function startGame() {
      gameRunning = true;
      score = 0;
      rocket.x = window.innerWidth / 2 - 25;
      rocket.y = window.innerHeight - 100;
      obstacles = [];
      coins = [];
      lastObstacleSpawn = performance.now();
      lastCoinSpawn = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function spawnObstacle(time) {
      if (time - lastObstacleSpawn > 1500) {
        const x = Math.random() * (window.innerWidth - 40);
        obstacles.push({ x, y: -50, width: 40, height: 40 });
        lastObstacleSpawn = time;
      }
    }

    function spawnCoin(time) {
      if (time - lastCoinSpawn > 1000) {
        const x = Math.random() * (window.innerWidth - 20);
        coins.push({ x, y: -20, width: 20, height: 20 });
        lastCoinSpawn = time;
      }
    }

    function updateStars() {
      for (let s of stars) {
        s.y += s.speed;
        if (s.y > window.innerHeight) {
          s.y = 0;
          s.x = Math.random() * window.innerWidth;
        }
      }
    }

    function drawStars() {
      ctx.fillStyle = "white";
      for (let s of stars) {
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function gameLoop(time) {
      if (!gameRunning) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      updateStars();
      drawStars();

      // Draw rocket (GIF anim works because we draw every frame)
      ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.width, rocket.height);

      spawnObstacle(time);
      spawnCoin(time);

      for (let o of obstacles) {
        o.y += 3;
        ctx.drawImage(obstacleImg, o.x, o.y, o.width, o.height);
      }

      for (let c of coins) {
        c.y += 2;
        ctx.drawImage(coinImg, c.x, c.y, c.width, c.height);
      }

      for (let o of obstacles) {
        if (checkCollision(rocket, o)) {
          gameRunning = false;
          document.getElementById("homeScreen").style.display = "flex";
          document.querySelector("#homeScreen p").innerText = `Таны оноо: ${score}`;
        }
      }

      for (let i = coins.length - 1; i >= 0; i--) {
        if (checkCollision(rocket, coins[i])) {
          score++;
          coins.splice(i, 1);
        }
      }

      obstacles = obstacles.filter(o => o.y < window.innerHeight);
      coins = coins.filter(c => c.y < window.innerHeight);

      ctx.font = `${Math.max(3, window.innerWidth / 20)}px Arial`;
      ctx.fillStyle = "white";
      ctx.fillText("Оноо: " + score, 10, 30);

      requestAnimationFrame(gameLoop);
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }
</script>