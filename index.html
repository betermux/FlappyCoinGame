<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game ¬∑ Telegram WebApp + Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f1a; --card:#101727cc; --txt:#eaf2ff; --muted:#9fb3ce;
      --accent:#ffd54a; --accent2:#58d3ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 70% -10%, #16213e 0%, #0b0f1a 55%, #090d16 100%);
      color:var(--txt); 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    h1, h2, .btn, th, td.score {font-family: 'Press Start 2P', cursive, monospace;}
    
    /* Top-left user badge */
    #userInfo{
      position: fixed; top: 12px; left: 12px; z-index: 20;
      display:flex; align-items:center; gap:10px;
      padding: 8px 12px; border-radius: 999px;
      background: linear-gradient(180deg, #0f1430aa, #0c1126aa);
      box-shadow: 0 8px 24px #0006, inset 0 0 0 1px #ffffff08;
      backdrop-filter: blur(8px);
    }
    #userPhoto{ width:32px; height:32px; border-radius:50%; object-fit:cover; }
    #userName{ font-weight:600; color:#fff }
    #userCoins{ font-weight:600; color:var(--accent2); margin-left: 5px; }

    /* Screens */
    .screen{
      position: fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:24px; z-index: 15;
      background: linear-gradient(180deg, #0a0f1ab3, #0a0f1acc);
      backdrop-filter: blur(6px);
    }
    #homeCard{
      width:min(720px, 92vw);
      background: var(--card);
      border-radius: 18px; padding: 22px;
      box-shadow: 0 16px 48px #0009, inset 0 0 0 1px #ffffff08;
      text-align:center;
    }
    .sub{ color:var(--muted); margin: 4px 0 18px; }
    .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

    /* Rocket GIF container - positioned absolutely */
    #rocketGif {
      position: absolute;
      width: 100px;
      height: 100px;
      pointer-events: none; /* So it doesn't interfere with touch events */
      z-index: 10; /* Make sure it appears above canvas but below UI */
      display: none; /* Hidden until game starts */
    }
    
    /* Canvas and game elements */
    #gameCanvas{ display:block; width:100vw; height:100vh; position:absolute; top:0; left:0; }
    
    /* Buttons */
    .btn{
      border:0; cursor:pointer;
      background: linear-gradient(180deg, #ffd54a, #ffb300);
      color:#2b1900; font-weight:700; letter-spacing: .3px;
      padding: 12px 18px; border-radius: 12px; 
      box-shadow: 0 8px 20px #ffb30052, inset 0 0 0 1px #ffffff08;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ filter:brightness(1.05) }
    .btn:active{ transform: translateY(1px) }

    /* Leaderboard styles remain unchanged */
    #leaderboardScreen{ display:none }
    #boardCard{
      width:min(860px, 96vw);
      background: var(--card);
      border-radius: 18px; padding: 18px 14px 14px;
      box-shadow: 0 16px 48px #0009, inset 0 0 0 1px #ffffff08;
    }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding: 10px 8px; text-align: left; border-bottom:1px solid #1d2740; }
    th{ color:#cfe1ff; text-transform: uppercase; letter-spacing: .6px; }
    td.rank{ width:56px; text-align:center; color:#7ec1ff }
    td.score{ font-weight:700; color:#fff }
    .pill{
      padding: 6px 10px; border-radius: 999px; background:#ffffff10; color:#dbe9ff; font-size: 12px;
    }
    .top1 .score{ color:#ffd54a }
    .top2 .score{ color:#c0e1ff }
    .top3 .score{ color:#ffc9a8 }
    .footerRow{ display:flex; justify-content:space-between; gap:8px; margin-top:14px }
    .ghost{ background:#ffffff14; color:#fff }
  </style>
</head>
<body>
  <!-- User profile badge -->
  <div id="userInfo" style="display:none;">
    <img id="userPhoto" alt="" />
    <span id="userName"></span>
    <span id="userCoins"></span>
  </div>

  <!-- Home screen -->
  <div id="homeScreen" class="screen">
    <div id="homeCard">
      <h1>üöÄ Space Rocket</h1>
      <div class="sub">Swipe left/right to control, avoid obstacles and collect <span style="color:#58d3ff">coins</span>!</div>
      <div class="row">
        <button id="startBtn" class="btn">Start Game</button>
        <button id="openBoardBtn" class="btn ghost">Leaderboard</button>
      </div>
    </div>
  </div>

  <!-- Game elements -->
  <canvas id="gameCanvas"></canvas>
  <div id="rocketGif"></div> <!-- Container for animated rocket GIF -->

  <!-- Leaderboard screen -->
  <div id="leaderboardScreen" class="screen">
    <div id="boardCard">
      <div style="display:flex; align-items:center; justify-content:space-between; padding: 0 8px 8px;">
        <h2 style="margin:8px 0 0; font-size:22px">üèÜ Leaderboard (Total Coin)</h2>
        <span id="entriesMeta" class="pill">‚Äî</span>
      </div>
      <div style="overflow:auto; max-height: 60vh;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Coin (Total)</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
      <div class="footerRow">
        <button id="backHome" class="btn ghost">‚¨Ö Home</button>
        <button id="playAgain" class="btn">üîÑ Play Again</button>
      </div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="bgMusic" src="assets/bgmusic.mp3" loop preload="auto"></audio>
  <audio id="popSound" src="assets/popsound.mp3" preload="auto"></audio>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, child, runTransaction } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.appspot.com",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ===== Telegram user ===== */
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    let currentUser = "guest";
    let currentUserId = "guest_id";
    let photoUrl = "";
    let userTotalCoins = 0;

    const user = tg?.initDataUnsafe?.user;
    if (user) {
      currentUserId = user.id.toString();
      currentUser = user.username || [user.first_name, user.last_name].filter(Boolean).join(" ");
      photoUrl = user.photo_url || "";
    }

    const userInfo = document.getElementById("userInfo");
    const userNameEl = document.getElementById("userName");
    const userPhotoEl = document.getElementById("userPhoto");
    const userCoinsEl = document.getElementById("userCoins");

    function showUserBadge(show){
      userInfo.style.display = show ? "flex" : "none";
    }

    async function updateUserInfoDisplay() {
      userNameEl.textContent = currentUser;
      if (photoUrl) userPhotoEl.src = photoUrl;

      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        const snapshot = await get(userRef);
        
        if (snapshot.exists()) {
          const existingData = snapshot.val();
          userTotalCoins = existingData.totalCoins || 0;
          
          if (existingData.username !== currentUser || existingData.photo_url !== photoUrl) {
            await update(userRef, {
              username: currentUser,
              photo_url: photoUrl
            });
          }
        } else {
          userTotalCoins = 0;
          await set(userRef, {
            username: currentUser,
            photo_url: photoUrl,
            totalCoins: 0,
            createdAt: new Date().toISOString()
          });
        }
        userCoinsEl.textContent = `ü™ô ${userTotalCoins}`;
      } else {
        userTotalCoins = 0;
        userCoinsEl.textContent = `(Guest)`;
      }
    }

    /* ===== Canvas / Game ===== */
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const rocketGif = document.getElementById("rocketGif");
    
    // Setup animated rocket GIF
    rocketGif.innerHTML = '<img src="assets/rocket.gif" style="width:100%; height:100%;">';
    const gifElement = rocketGif.firstChild;
    gifElement.style.display = 'none'; // Hidden until game starts

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // Rocket collision image (invisible)
    const rocketImg = new Image(); 
    rocketImg.src = "assets/rocket.png";
    
    // Other game assets
    const obstacleImg = new Image(); obstacleImg.src = "assets/obstacle.png";
    const coinImg = new Image(); coinImg.src = "assets/coin.png";

    // Audio elements
    const bgMusic = document.getElementById('bgMusic');
    bgMusic.volume = 0.3;
    const popSound = document.getElementById('popSound');
    popSound.volume = 0.7;
    const coinCollectSound = new Audio('assets/coincollect.mp3');
    coinCollectSound.volume = 0.5;

    // Rocket properties
    let rocket = { 
      x: window.innerWidth/2-50, 
      y: window.innerHeight-200, 
      w: 100, 
      h: 100,
      targetX: window.innerWidth/2-50,
      speed: 0.15,
      rotation: 0,
      targetRotation: 0,
      rotationSpeed: 0.1,
      collisionOffsetX: 25,
      collisionOffsetY: 10,
      collisionWidthShrink: 50,
      collisionHeightShrink: 20
    };

    // Game state
    let running = false, score = 0;
    let obstacles = [], coins = [];
    let touchStartX = null;

    const ROTATION_ANGLE_RAD = 10 * Math.PI / 180;

    // Touch controls
    canvas.addEventListener("touchstart", e => { 
      touchStartX = e.touches[0].clientX; 
      rocket.targetX = Math.max(0, Math.min(e.touches[0].clientX - rocket.w / 2, window.innerWidth - rocket.w));
    }, {passive:true});

    canvas.addEventListener("touchmove", e => {
      const currentTouchX = e.touches[0].clientX;
      const newTargetX = Math.max(0, Math.min(currentTouchX - rocket.w / 2, window.innerWidth - rocket.w));
      
      if (newTargetX < rocket.x) {
        rocket.targetRotation = -ROTATION_ANGLE_RAD;
      } else if (newTargetX > rocket.x) {
        rocket.targetRotation = ROTATION_ANGLE_RAD;
      } else {
        rocket.targetRotation = 0;
      }

      rocket.targetX = newTargetX;
    }, {passive:true});

    canvas.addEventListener("touchend", e => {
      if (touchStartX == null) return;
      const finalTouchX = e.changedTouches[0].clientX;
      rocket.targetX = Math.max(0, Math.min(finalTouchX - rocket.w / 2, window.innerWidth - rocket.w));
      rocket.targetRotation = 0;
      touchStartX = null;
    });

    // Game objects spawn
    function spawnObstacle(){
      const size = 72;
      const obstacleCollisionPadding = 18;
      obstacles.push({
        x: Math.random()*(window.innerWidth-size), 
        y: -size, 
        w: size, 
        h: size, 
        vy: 3, 
        rotation: 0, 
        rotationSpeed: (Math.random() - 0.5) * 0.05,
        collisionPadding: obstacleCollisionPadding
      }); 
    }

    function spawnCoin(){
      const size = 44;
      coins.push({
        x: Math.random()*(window.innerWidth-size), 
        y: -size, 
        w: size, 
        h: size, 
        vy: 2,
        alpha: 1,
        collected: false
      });
    }

    // Main game loop
    function loop(t){
      if (!running) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Update rocket position
      rocket.x += (rocket.targetX - rocket.x) * rocket.speed;
      rocket.rotation += (rocket.targetRotation - rocket.rotation) * rocket.rotationSpeed;
      
      // Update animated GIF position to match rocket
      const screenY = window.innerHeight - rocket.y - rocket.h; // Convert canvas Y to screen Y
      rocketGif.style.left = rocket.x + 'px';
      rocketGif.style.top = screenY + 'px';
      rocketGif.style.transform = `rotate(${rocket.rotation}rad)`;
      
      // Spawn objects
      if (Math.random() < 0.008) spawnObstacle();
      if (Math.random() < 0.02) spawnCoin();

      // Draw and update obstacles
      for (const o of obstacles){ 
        o.y += o.vy; 
        o.rotation += o.rotationSpeed;
        if (obstacleImg.complete) {
          ctx.save();
          ctx.translate(o.x + o.w / 2, o.y + o.h / 2);
          ctx.rotate(o.rotation);
          ctx.drawImage(obstacleImg, -o.w / 2, -o.h / 2, o.w, o.h);
          ctx.restore();
        }
      }
      obstacles = obstacles.filter(o => o.y < window.innerHeight + o.h + 40);

      // Draw and update coins
      for (const c of coins){ 
        if (!c.collected) {
          c.y += c.vy; 
        } else {
          c.alpha -= 0.05;
          if (c.alpha < 0) c.alpha = 0;
        }

        if (coinImg.complete && c.alpha > 0) {
          ctx.save();
          ctx.globalAlpha = c.alpha;
          ctx.drawImage(coinImg, c.x, c.y, c.w, c.h); 
          ctx.restore();
        }
      }
      coins = coins.filter(c => c.y < window.innerHeight + c.h + 22 && c.alpha > 0);

      // Draw invisible rocket for collision
      if (rocketImg.complete) {
        ctx.save();
        ctx.globalAlpha = 0; // Completely transparent
        ctx.translate(rocket.x + rocket.w / 2, rocket.y + rocket.h / 2);
        ctx.rotate(rocket.rotation);
        ctx.drawImage(rocketImg, -rocket.w / 2, -rocket.h / 2, rocket.w, rocket.h);
        ctx.restore();
      }

      // Collision detection
      for (const o of obstacles){ if (hit(rocket, o)){ return endGame(); } }
      for (let i = coins.length - 1; i >= 0; i--){ 
        if (!coins[i].collected && hit(rocket, coins[i])){ 
          score++; 
          coins[i].collected = true;
          const playSound = new Audio('assets/coincollect.mp3');
          playSound.volume = 0.5;
          playSound.play().catch(e => console.error("Error playing sound:", e));
        } 
      }

      // Draw HUD
      ctx.fillStyle = "#eaf2ff"; 
      ctx.font = "20px 'Press Start 2P'";
      ctx.fillText("Coin: " + score, 12, 28);

      requestAnimationFrame(loop);
    }

    // Collision detection
    function hit(a, b){
      const aX = a.x + a.collisionOffsetX;
      const aY = a.y + a.collisionOffsetY;
      const aW = a.w - a.collisionWidthShrink;
      const aH = a.h - a.collisionHeightShrink;

      const bPadding = b.collisionPadding !== undefined ? b.collisionPadding : 0; 
      const bX = b.x + bPadding;
      const bY = b.y + bPadding;
      const bW = b.w - (bPadding * 2);
      const bH = b.h - (bPadding * 2);

      return aX < bX + bW && aX + aW > bX && aY < bY + bH && aY + aH > bY;
    }

    /* ===== Screens & Leaderboard ===== */
    const homeScreen = document.getElementById("homeScreen");
    const boardScreen = document.getElementById("leaderboardScreen");
    const startBtn = document.getElementById("startBtn");
    const openBoardBtn = document.getElementById("openBoardBtn");
    const backHome = document.getElementById("backHome");
    const playAgain = document.getElementById("playAgain");
    const tbody = document.getElementById("leaderboardBody");
    const entriesMeta = document.getElementById("entriesMeta");

    // Button sound effects
    const allButtons = document.querySelectorAll('.btn');
    allButtons.forEach(button => {
        button.addEventListener('click', () => {
            popSound.currentTime = 0;
            popSound.play().catch(e => console.error("Error playing pop sound:", e));
        });
    });

    // Game controls
    startBtn.addEventListener("click", ()=>{
      showUserBadge(false);
      homeScreen.style.display = "none";
      score = 0; obstacles = []; coins = [];
      rocket.x = window.innerWidth/2 - rocket.w/2;
      rocket.targetX = rocket.x;
      rocket.y = window.innerHeight - 200;
      rocket.rotation = 0;
      rocket.targetRotation = 0;
      running = true;
      
      // Show and position animated rocket
      gifElement.style.display = 'block';
      rocketGif.style.display = 'block';
      
      bgMusic.play().catch(e => console.error("Error playing background music:", e));
      requestAnimationFrame(loop);
    });

    openBoardBtn.addEventListener("click", async ()=>{
      bgMusic.pause();
      bgMusic.currentTime = 0;
      gifElement.style.display = 'none';
      await showLeaderboard();
      homeScreen.style.display = "none";
      boardScreen.style.display = "flex";
      showUserBadge(true);
    });

    backHome.addEventListener("click", ()=>{
      bgMusic.pause();
      bgMusic.currentTime = 0;
      gifElement.style.display = 'none';
      boardScreen.style.display = "none";
      homeScreen.style.display = "flex";
      showUserBadge(true);
    });

    playAgain.addEventListener("click", ()=>{
      boardScreen.style.display = "none";
      showUserBadge(false);
      startBtn.click();
    });

    // Game over handler
    async function endGame(){
      running = false;
      gifElement.style.display = 'none';
      bgMusic.pause();
      bgMusic.currentTime = 0;

      if (currentUserId !== "guest_id") {
        const userRef = ref(db, `users/${currentUserId}`);
        await runTransaction(userRef, (currentData) => {
          if (currentData) {
            currentData.totalCoins = (currentData.totalCoins || 0) + score;
          } else {
            currentData = {
              username: currentUser,
              photo_url: photoUrl,
              totalCoins: score,
              createdAt: new Date().toISOString()
            };
          }
          return currentData;
        });
        await updateUserInfoDisplay();
      }

      await showLeaderboard();
      boardScreen.style.display = "flex";
      showUserBadge(true);
    }

    // Leaderboard functions
    async function showLeaderboard(){
      tbody.innerHTML = `<tr><td colspan="3" style="padding:16px; color:#cfe1ff">Loading...</td></tr>`; 
      const usersRef = ref(db, "users");
      const snapshot = await get(usersRef);
      
      if (!snapshot.exists()){
        tbody.innerHTML = `<tr><td colspan="3" style="padding:16px; color:#cfe1ff">No coins collected yet.</td></tr>`; 
        entriesMeta.textContent = "0 players";
        return;
      }

      const usersList = Object.values(snapshot.val());
      const sortedUsers = usersList
        .filter(u => u.totalCoins !== undefined)
        .sort((a,b) => b.totalCoins - a.totalCoins);

      tbody.innerHTML = "";
      sortedUsers.forEach((u, idx) => {
        const tr = document.createElement("tr");
        if (idx === 0) tr.classList.add("top1");
        else if (idx === 1) tr.classList.add("top2");
        else if (idx === 2) tr.classList.add("top3");
        tr.innerHTML = `
          <td class="rank">${idx+1}</td>
          <td>${u.username}</td>
          <td class="score">${u.totalCoins}</td>
        `;
        tbody.appendChild(tr);
      });
      entriesMeta.textContent = `${sortedUsers.length} players`;
    }

    // Initialize
    updateUserInfoDisplay();
    showUserBadge(true);
  </script>
</body>
</html>
