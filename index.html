<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game ¬∑ Telegram WebApp + Leaderboard</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#101727cc; --txt:#eaf2ff; --muted:#9fb3ce;
      --accent:#ffd54a; --accent2:#58d3ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 70% -10%, #16213e 0%, #0b0f1a 55%, #090d16 100%);
      color:var(--txt); font-family:sans-serif; overflow:hidden;
    }
    #userInfo{
      position: fixed; top: 12px; left: 12px; z-index: 20;
      display:flex; align-items:center; gap:10px;
      padding: 8px 12px; border-radius: 999px;
      background: linear-gradient(180deg, #0f1430aa, #0c1126aa);
      box-shadow: 0 8px 24px #0006, inset 0 0 0 1px #ffffff14;
      backdrop-filter: blur(8px);
    }
    #userPhoto{ width:32px; height:32px; border-radius:50%; object-fit:cover; }
    #userName{ font-weight:600; color:#fff }
    .screen{position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; z-index:15; background:linear-gradient(180deg,#0a0f1ab3,#0a0f1acc); backdrop-filter:blur(6px);}
    #homeScreen h1{margin:0 0 8px; font-size: clamp(24px,6vw,42px);}
    #homeCard{width:min(720px,92vw); background:var(--card); border-radius:18px; padding:22px; box-shadow:0 16px 48px #0009, inset 0 0 0 1px #ffffff14; text-align:center;}
    .sub{ color:var(--muted); margin:4px 0 18px;}
    .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap;}
    .btn{border:0; cursor:pointer; background:linear-gradient(180deg,#ffd54a,#ffb300); color:#2b1900; font-weight:700; padding:12px 18px; border-radius:12px; font-size:clamp(16px,4vw,18px);}
    #gameCanvas{display:block; width:100vw; height:100vh;}
    #leaderboardScreen{display:none}
    #boardCard{width:min(860px,96vw); background:var(--card); border-radius:18px; padding:18px 14px; box-shadow:0 16px 48px #0009, inset 0 0 0 1px #ffffff14;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px 8px; text-align:left; border-bottom:1px solid #1d2740;}
    th{color:#cfe1ff; font-size:14px; text-transform:uppercase; letter-spacing:.6px;}
    td.rank{width:56px; text-align:center; color:#7ec1ff}
    td.score{font-weight:700; color:#fff}
    .top1 .score{color:#ffd54a} .top2 .score{color:#c0e1ff} .top3 .score{color:#ffc9a8}
  </style>
</head>
<body>
  <div id="userInfo" style="display:none;">
    <img id="userPhoto" alt="" />
    <span id="userName"></span>
  </div>

  <div id="homeScreen" class="screen">
    <div id="homeCard">
      <h1>üöÄ Space Rocket</h1>
      <div class="sub">Swipe-–∞–∞—Ä —É–¥–∏—Ä–¥–∞–∂ —Å–∞–∞–¥ —Ç–æ–π—Ä–æ–Ω <span style="color:#58d3ff">coin</span> —Ü—É–≥–ª—É—É–ª!</div>
      <div class="row">
        <button id="startBtn" class="btn">Start Game</button>
        <button id="openBoardBtn" class="btn">Leaderboard</button>
      </div>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="leaderboardScreen" class="screen">
    <div id="boardCard">
      <h2 style="margin:8px 0 14px;">üèÜ Leaderboard (–Ω–∏–π–ª–±—ç—Ä –æ–Ω–æ–æ)</h2>
      <div style="overflow:auto; max-height:60vh;">
        <table>
          <thead><tr><th>#</th><th>–ù—ç—Ä</th><th>–û–Ω–æ–æ (–Ω–∏–π—Ç)</th></tr></thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:12px;">
        <button id="backHome" class="btn">‚¨Ö –ù“Ø“Ø—Ä</button>
        <button id="playAgain" class="btn">üîÑ –î–∞—Ö–∏–Ω —Ç–æ–≥–ª–æ—Ö</button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    const firebaseConfig={apiKey:"AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",authDomain:"ballonyup.firebaseapp.com",databaseURL:"https://ballonyup-default-rtdb.firebaseio.com",projectId:"ballonyup",storageBucket:"ballonyup.firebasestorage.app",messagingSenderId:"641854409703",appId:"1:641854409703:web:69933dac88bc7184874b42",measurementId:"G-94EH113TS5"};
    const app = initializeApp(firebaseConfig); const db = getDatabase(app);

    const tg = window.Telegram?.WebApp; tg?.expand();
    const user = tg?.initDataUnsafe?.user;
    let currentUser="guest", photoUrl="";
    if(user){ currentUser=user.username||[user.first_name,user.last_name].filter(Boolean).join(" "); photoUrl=user.photo_url||""; }
    const userInfo=document.getElementById("userInfo"); const userNameEl=document.getElementById("userName"); const userPhotoEl=document.getElementById("userPhoto");
    function showUserBadge(show){ userInfo.style.display=show?"flex":"none"; }
    userNameEl.textContent=currentUser; if(photoUrl) userPhotoEl.src=photoUrl;

    const canvas=document.getElementById("gameCanvas"); const ctx=canvas.getContext("2d");
    function resize(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;} resize(); window.addEventListener("resize",resize);

    // stars
    const stars=[]; for(let i=0;i<80;i++){stars.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,r:Math.random()*2+0.6,s:0.5+Math.random()*1.6});}
    function updateStars(){for(const s of stars){s.y+=s.s;if(s.y>window.innerHeight){s.y=-3;s.x=Math.random()*window.innerWidth;}}}
    function drawStars(){ctx.fillStyle="#fff";for(const s of stars){ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();}}

    const rocketImg=new Image(); rocketImg.src="assets/rocket.gif";
    const obstacleImg=new Image(); obstacleImg.src="assets/obstacle.gif";
    const coinImg=new Image(); coinImg.src="assets/coin.png";

    let running=false, score=0;
    let rocket={x:window.innerWidth/2-50,y:window.innerHeight-160,w:100,h:100};
    let obstacles=[], coins=[];

    // free drag movement
    canvas.addEventListener("touchmove",e=>{
      const t=e.touches[0]; rocket.x=t.clientX-rocket.w/2; rocket.y=t.clientY-rocket.h/2;
    },{passive:true});

    function spawnObstacle(){obstacles.push({x:Math.random()*(window.innerWidth-72),y:-72,w:72,h:72,vy:3});}
    function spawnCoin(){coins.push({x:Math.random()*(window.innerWidth-44),y:-44,w:44,h:44,vy:2});}

    function loop(){
      if(!running)return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      updateStars(); drawStars();
      if(Math.random()<0.015) spawnObstacle();
      if(Math.random()<0.018) spawnCoin();
      for(const o of obstacles){o.y+=o.vy;ctx.drawImage(obstacleImg,o.x,o.y,o.w,o.h);}
      obstacles=obstacles.filter(o=>o.y<window.innerHeight+80);
      for(const c of coins){c.y+=c.vy;ctx.drawImage(coinImg,c.x,c.y,c.w,c.h);}
      coins=coins.filter(c=>c.y<window.innerHeight+50);
      ctx.drawImage(rocketImg,rocket.x,rocket.y,rocket.w,rocket.h);
      // collision box shrink
      const pad=15;
      const rbox={x:rocket.x+pad,y:rocket.y+pad,w:rocket.w-2*pad,h:rocket.h-2*pad};
      for(const o of obstacles){if(hit(rbox,o))return endGame();}
      for(let i=coins.length-1;i>=0;i--){if(hit(rbox,coins[i])){score++;coins.splice(i,1);}}
      ctx.fillStyle="#fff";ctx.font="20px Arial";ctx.fillText("–û–Ω–æ–æ: "+score,12,28);
      requestAnimationFrame(loop);
    }
    function hit(a,b){return a.x<a.x+a.w && a.x+b.w> b.x && a.y<a.y+a.h && a.y+b.h> b.y && a.x<b.x+b.w && a.y<b.y+b.h && a.x+a.w> b.x && a.y+a.h> b.y}
    function hit(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

    const homeScreen=document.getElementById("homeScreen"); const boardScreen=document.getElementById("leaderboardScreen");
    document.getElementById("startBtn").addEventListener("click",()=>{showUserBadge(false);homeScreen.style.display="none";score=0;obstacles=[];coins=[];rocket.x=window.innerWidth/2-50;rocket.y=window.innerHeight-160;running=true;requestAnimationFrame(loop);});
    document.getElementById("openBoardBtn").addEventListener("click",async()=>{await showLeaderboard();homeScreen.style.display="none";boardScreen.style.display="flex";showUserBadge(true);});
    document.getElementById("backHome").addEventListener("click",()=>{boardScreen.style.display="none";homeScreen.style.display="flex";showUserBadge(true);});
    document.getElementById("playAgain").addEventListener("click",()=>{boardScreen.style.display="none";showUserBadge(false);document.getElementById("startBtn").click();});

    async function endGame(){running=false;const scoresRef=ref(db,"scores");await set(push(scoresRef),{username:currentUser,score,createdAt:new Date().toISOString()});await showLeaderboard();boardScreen.style.display="flex";showUserBadge(true);}
    async function showLeaderboard(){const tbody=document.getElementById("leaderboardBody");const snapshot=await get(child(ref(db),"scores"));if(!snapshot.exists()){tbody.innerHTML="<tr><td colspan=3>–û–¥–æ–æ–≥–æ–æ—Ä –æ–Ω–æ–æ –∞–ª–≥–∞.</td></tr>";return;}
      const list=Object.values(snapshot.val());const byUser=new Map();for(const row of list){const name=row.username||"guest";const s=+row.score||0;if(!byUser.has(name)){byUser.set(name,{username:name,total:s});}else{byUser.get(name).total+=s;}}
      const aggregated=[...byUser.values()].sort((a,b)=>b.total-a.total);tbody.innerHTML="";aggregated.forEach((u,idx)=>{const tr=document.createElement("tr");if(idx===0)tr.classList.add("top1");else if(idx===1)tr.classList.add("top2");else if(idx===2)tr.classList.add("top3");tr.innerHTML=`<td class="rank">${idx+1}</td><td>${u.username}</td><td class="score">${u.total}</td>`;tbody.appendChild(tr);});}
    showUserBadge(true);
  </script>
</body>
</html>