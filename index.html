<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game ¬∑ Telegram WebApp + Leaderboard</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#101727cc; --txt:#eaf2ff; --muted:#9fb3ce;
      --accent:#ffd54a; --accent2:#58d3ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 70% -10%, #16213e 0%, #0b0f1a 55%, #090d16 100%);
      color:var(--txt); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }
    /* Top-left user badge */
    #userInfo{
      position: fixed; top: 12px; left: 12px; z-index: 20;
      display:flex; align-items:center; gap:10px;
      padding: 8px 12px; border-radius: 999px;
      background: linear-gradient(180deg, #0f1430aa, #0c1126aa);
      box-shadow: 0 8px 24px #0006, inset 0 0 0 1px #ffffff14;
      backdrop-filter: blur(8px);
    }
    #userPhoto{ width:32px; height:32px; border-radius:50%; object-fit:cover; }
    #userName{ font-weight:600; color:#fff }

    /* Screens */
    .screen{
      position: fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:24px; z-index: 15;
      background: linear-gradient(180deg, #0a0f1ab3, #0a0f1acc);
      backdrop-filter: blur(6px);
    }
    #homeScreen h1{
      margin:0 0 8px; font-size: clamp(24px, 6vw, 42px);
      letter-spacing: 0.5px;
    }
    #homeCard{
      width:min(720px, 92vw);
      background: var(--card);
      border-radius: 18px; padding: 22px;
      box-shadow: 0 16px 48px #0009, inset 0 0 0 1px #ffffff14;
      text-align:center;
    }
    .sub{ color:var(--muted); margin: 4px 0 18px; }
    .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

    .btn{
      border:0; cursor:pointer;
      background: linear-gradient(180deg, #ffd54a, #ffb300);
      color:#2b1900; font-weight:700; letter-spacing: .3px;
      padding: 12px 18px; border-radius: 12px; font-size: clamp(16px, 4vw, 18px);
      box-shadow: 0 8px 20px #ffb30052, inset 0 0 0 1px #0000001f;
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ filter:brightness(1.05) }
    .btn:active{ transform: translateY(1px) }

    /* Canvas */
    #gameCanvas{ display:block; width:100vw; height:100vh; }

    /* Leaderboard */
    #leaderboardScreen{ display:none }
    #boardCard{
      width:min(860px, 96vw);
      background: var(--card);
      border-radius: 18px; padding: 18px 14px 14px;
      box-shadow: 0 16px 48px #0009, inset 0 0 0 1px #ffffff14;
    }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding: 10px 8px; text-align: left; border-bottom:1px solid #1d2740; }
    th{ color:#cfe1ff; font-size: 14px; text-transform: uppercase; letter-spacing: .6px; }
    td.rank{ width:56px; text-align:center; color:#7ec1ff }
    td.score{ font-weight:700; color:#fff }
    .pill{
      padding: 6px 10px; border-radius: 999px; background:#ffffff10; color:#dbe9ff; font-size: 12px;
    }
    .top1 .score{ color:#ffd54a }
    .top2 .score{ color:#c0e1ff }
    .top3 .score{ color:#ffc9a8 }

    .footerRow{ display:flex; justify-content:space-between; gap:8px; margin-top:14px }
    .ghost{ background:#ffffff14; color:#fff }
  </style>
</head>
<body>
  <!-- Telegram user badge (home & leaderboard –¥—ç—ç—Ä –ª —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞) -->
  <div id="userInfo" style="display:none;">
    <img id="userPhoto" alt="" />
    <span id="userName"></span>
  </div>

  <!-- Home -->
  <div id="homeScreen" class="screen">
    <div id="homeCard">
      <h1>üöÄ Space Rocket</h1>
      <div class="sub">–ó“Ø“Ø–Ω/–±–∞—Ä—É—É–Ω swipe‚Äî–∞–∞—Ä —É–¥–∏—Ä–¥–∞–∂, —Å–∞–∞–¥—É—É–¥—ã–≥ —Ç–æ–π—Ä–æ–Ω <span style="color:#58d3ff">coin</span> —Ü—É–≥–ª—É—É–ª!</div>
      <div class="row">
        <button id="startBtn" class="btn">Start Game</button>
        <button id="openBoardBtn" class="btn ghost">Leaderboard</button>
      </div>
    </div>
  </div>

  <!-- Game canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Leaderboard -->
  <div id="leaderboardScreen" class="screen">
    <div id="boardCard">
      <div style="display:flex; align-items:center; justify-content:space-between; padding: 0 8px 8px;">
        <h2 style="margin:8px 0 0; font-size:22px">üèÜ Leaderboard (–Ω–∏–π–ª–±—ç—Ä –æ–Ω–æ–æ)</h2>
        <span id="entriesMeta" class="pill">‚Äî</span>
      </div>
      <div style="overflow:auto; max-height: 60vh;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>–ù—ç—Ä</th>
              <th>–û–Ω–æ–æ (–Ω–∏–π—Ç)</th>
              <th>–°“Ø“Ø–ª–∏–π–Ω —Ç–æ–≥–ª–æ–ª—Ç</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
      <div class="footerRow">
        <button id="backHome" class="btn ghost">‚¨Ö –ù“Ø“Ø—Ä</button>
        <button id="playAgain" class="btn">üîÑ –î–∞—Ö–∏–Ω —Ç–æ–≥–ª–æ—Ö</button>
      </div>
    </div>
  </div>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.firebasestorage.app",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42",
      measurementId: "G-94EH113TS5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ===== Telegram user ===== */
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const user = tg?.initDataUnsafe?.user;
    let currentUser = "guest";
    let photoUrl = "";
    if (user) {
      currentUser = user.username || [user.first_name, user.last_name].filter(Boolean).join(" ");
      photoUrl = user.photo_url || "";
    }
    const userInfo = document.getElementById("userInfo");
    const userNameEl = document.getElementById("userName");
    const userPhotoEl = document.getElementById("userPhoto");
    function showUserBadge(show){
      userInfo.style.display = show ? "flex" : "none";
    }
    userNameEl.textContent = currentUser;
    if (photoUrl) userPhotoEl.src = photoUrl;

    /* ===== Canvas / Game ===== */
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    // parallax stars
    const stars = [];
    for (let i=0;i<80;i++){
      stars.push({x:Math.random()*window.innerWidth, y:Math.random()*window.innerHeight, r:Math.random()*2+0.6, s:0.5+Math.random()*1.6});
    }
    function updateStars(){
      for (const s of stars){ s.y += s.s; if (s.y>window.innerHeight){ s.y=-3; s.x=Math.random()*window.innerWidth; } }
    }
    function drawStars(){
      ctx.fillStyle="#fff";
      for (const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }
    }

    // assets
    const rocketImg = new Image(); rocketImg.src = "assets/rocket.gif";
    const obstacleImg = new Image(); obstacleImg.src = "assets/obstacle.gif";
    const coinImg = new Image(); coinImg.src = "assets/coin.png";

    let running=false, score=0;
    let rocket = { x: window.innerWidth/2-25, y: window.innerHeight-120, w: 50, h: 50 };
    let obstacles=[], coins=[];
    let touchStartX=null;

    canvas.addEventListener("touchstart", e => { touchStartX = e.touches[0].clientX; }, {passive:true});
    canvas.addEventListener("touchend", e => {
      if (touchStartX==null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (dx>40) rocket.x = Math.min(rocket.x+60, window.innerWidth - rocket.w);
      if (dx<-40) rocket.x = Math.max(rocket.x-60, 0);
      touchStartX=null;
    });

    function spawnObstacle(){
      const size=36;
      obstacles.push({x:Math.random()*(window.innerWidth-size), y:-size, w:size, h:size, vy:3});
    }
    function spawnCoin(){
      const size=22;
      coins.push({x:Math.random()*(window.innerWidth-size), y:-size, w:size, h:size, vy:2});
    }

    function loop(t){
      if (!running) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // bg
      updateStars(); drawStars();

      // spawn
      if (Math.random()<0.018) spawnObstacle();
      if (Math.random()<0.02) spawnCoin();

      // draw
      for (const o of obstacles){ o.y+=o.vy; if (obstacleImg.complete) ctx.drawImage(obstacleImg,o.x,o.y,o.w,o.h); }
      obstacles = obstacles.filter(o=>o.y<window.innerHeight+40);

      for (const c of coins){ c.y+=c.vy; if (coinImg.complete) ctx.drawImage(coinImg,c.x,c.y,c.w,c.h); }
      coins = coins.filter(c=>c.y<window.innerHeight+22);

      if (rocketImg.complete) ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.w, rocket.h);

      // collisions
      for (const o of obstacles){ if (hit(rocket,o)){ return endGame(); } }
      for (let i=coins.length-1;i>=0;i--){ if (hit(rocket,coins[i])){ score++; coins.splice(i,1); } }

      // HUD
      ctx.fillStyle="#eaf2ff"; ctx.font="20px Arial"; ctx.fillText("–û–Ω–æ–æ: "+score, 12, 28);

      requestAnimationFrame(loop);
    }

    function hit(a,b){
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }

    /* ===== Screens & Leaderboard ===== */
    const homeScreen = document.getElementById("homeScreen");
    const boardScreen = document.getElementById("leaderboardScreen");
    const startBtn = document.getElementById("startBtn");
    const openBoardBtn = document.getElementById("openBoardBtn");
    const backHome = document.getElementById("backHome");
    const playAgain = document.getElementById("playAgain");
    const tbody = document.getElementById("leaderboardBody");
    const entriesMeta = document.getElementById("entriesMeta");

    startBtn.addEventListener("click", ()=>{
      // —Ç–æ–≥–ª–æ–æ–º —ç—Ö–ª—ç—Ö “Ø–µ–¥ badge-–∏–π–≥ –Ω—É—É—Ö
      showUserBadge(false);
      homeScreen.style.display="none";
      score=0; obstacles.length=0; coins.length=0;
      rocket.x = window.innerWidth/2-25; rocket.y = window.innerHeight-120;
      running=true;
      requestAnimationFrame(loop);
    });

    openBoardBtn.addEventListener("click", async ()=>{
      await showLeaderboard();
      homeScreen.style.display="none";
      boardScreen.style.display="flex";
      // leaderboard –¥—ç—ç—Ä badge —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
      showUserBadge(true);
    });

    backHome.addEventListener("click", ()=>{
      boardScreen.style.display="none";
      homeScreen.style.display="flex";
      showUserBadge(true);
    });

    playAgain.addEventListener("click", ()=>{
      boardScreen.style.display="none";
      showUserBadge(false);
      startBtn.click();
    });

    async function endGame(){
      running=false;
      // save single session
      const scoresRef = ref(db, "scores");
      const newRef = push(scoresRef);
      await set(newRef, { username: currentUser, score, createdAt: new Date().toISOString() });
      // show aggregated leaderboard
      await showLeaderboard();
      boardScreen.style.display="flex";
      // —Ç–æ–≥–ª–æ–æ–º –¥—É—É—Å—Å–∞–Ω —Ç—É–ª badge –¥–∞—Ö–∏–Ω —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
      showUserBadge(true);
    }

    /**
     * Aggregated leaderboard (sum by username)
     * DB: scores/{id} -> { username, score, createdAt }
     * UI: –Ω—ç–≥ username –Ω—ç–≥ –º”©—Ä, –æ–Ω–æ–æ = SUM(score)
     */
    async function showLeaderboard(){
      tbody.innerHTML = `<tr><td colspan="4" style="padding:16px; color:#cfe1ff">–£–Ω—à–∏–∂ –±–∞–π–Ω–∞...</td></tr>`;
      const snapshot = await get(child(ref(db), "scores"));
      if (!snapshot.exists()){
        tbody.innerHTML = `<tr><td colspan="4" style="padding:16px; color:#cfe1ff">–û–¥–æ–æ–≥–æ–æ—Ä –æ–Ω–æ–æ –∞–ª–≥–∞.</td></tr>`;
        entriesMeta.textContent = "0 —Ç–æ–≥–ª–æ–≥—á";
        return;
      }

      // aggregate by username
      const list = Object.values(snapshot.val()); // [{username, score, createdAt}, ...]
      const byUser = new Map();
      for (const row of list){
        const name = row.username || "guest";
        const s = Number(row.score)||0;
        const t = row.createdAt ? new Date(row.createdAt).getTime() : 0;
        if (!byUser.has(name)){
          byUser.set(name, { username:name, total:s, last:t });
        } else {
          const rec = byUser.get(name);
          rec.total += s;
          rec.last = Math.max(rec.last, t);
        }
      }
      const aggregated = Array.from(byUser.values())
        .sort((a,b)=> b.total - a.total || b.last - a.last);

      // render
      tbody.innerHTML = "";
      aggregated.forEach((u, idx)=>{
        const tr = document.createElement("tr");
        if (idx===0) tr.classList.add("top1");
        else if (idx===1) tr.classList.add("top2");
        else if (idx===2) tr.classList.add("top3");
        tr.innerHTML = `
          <td class="rank">${idx+1}</td>
          <td>${u.username}</td>
          <td class="score">${u.total}</td>
          <td><span class="pill">${u.last? new Date(u.last).toLocaleString(): "-"}</span></td>
        `;
        tbody.appendChild(tr);
      });
      entriesMeta.textContent = `${aggregated.length} —Ç–æ–≥–ª–æ–≥—á`;
    }

    // —ç—Ö–Ω–∏–π –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä badge —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
    showUserBadge(true);
  </script>
</body>
</html>