<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Rocket Game with Leaderboard</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: Arial; overflow: hidden; }
    #gameCanvas { display: block; width: 100%; height: 80vh; background: black; }
    #homeScreen, #leaderboardScreen {
      position: absolute; top:0; left:0; right:0; bottom:0;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.9);
    }
    #leaderboardScreen { display: none; }
    #startBtn { padding: 10px 20px; background: gold; border:none; border-radius:10px; font-size:20px; cursor:pointer; }
    table { width:90%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #444; padding:5px; text-align:center; }
    th { background:#222; }
    button { margin:2px; padding:5px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Home screen -->
  <div id="homeScreen">
    <h1>üöÄ Space Rocket</h1>
    <input type="text" id="usernameInput" placeholder="–¢–∞–Ω—ã –Ω—ç—Ä">
    <button id="startBtn">Start Game</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Leaderboard -->
  <div id="leaderboardScreen">
    <h2>üèÜ Leaderboard</h2>
    <table>
      <thead>
        <tr><th>–ù—ç—Ä</th><th>–û–Ω–æ–æ</th><th>–û–Ω —Å–∞—Ä</th><th id="adminCol"></th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button onclick="restart()">üîÑ –î–∞—Ö–∏–Ω —Ç–æ–≥–ª–æ—Ö</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, push, set, get, child, remove, update } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCeD_9k4rfspxHa_T8KAZRhkPT_deFP-OA",
      authDomain: "ballonyup.firebaseapp.com",
      databaseURL: "https://ballonyup-default-rtdb.firebaseio.com",
      projectId: "ballonyup",
      storageBucket: "ballonyup.firebasestorage.app",
      messagingSenderId: "641854409703",
      appId: "1:641854409703:web:69933dac88bc7184874b42",
      measurementId: "G-94EH113TS5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.8;

    // UI
    const homeScreen = document.getElementById("homeScreen");
    const leaderboardScreen = document.getElementById("leaderboardScreen");
    const startBtn = document.getElementById("startBtn");
    const usernameInput = document.getElementById("usernameInput");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const adminCol = document.getElementById("adminCol");

    let currentUser = "";
    let score = 0;
    let rocket = { x: canvas.width/2-25, y: canvas.height-100, width:50, height:50 };
    let obstacles = [];
    let coins = [];
    let running = false;

    // Assets
    const rocketImg = new Image(); rocketImg.src = "assets/rocket.gif";
    const obstacleImg = new Image(); obstacleImg.src = "assets/obstacle.gif";
    const coinImg = new Image(); coinImg.src = "assets/coin.png";

    // Swipe control
    let touchStartX = null;
    canvas.addEventListener("touchstart", e => { touchStartX = e.touches[0].clientX; });
    canvas.addEventListener("touchend", e => {
      if (!touchStartX) return;
      let dx = e.changedTouches[0].clientX - touchStartX;
      if (dx > 50) rocket.x += 50;
      if (dx < -50) rocket.x -= 50;
      touchStartX = null;
    });

    // Start game
    startBtn.onclick = () => {
      currentUser = usernameInput.value.trim();
      if (!currentUser) { alert("–ù—ç—Ä—ç—ç –æ—Ä—É—É–ª!"); return; }
      homeScreen.style.display="none";
      score = 0; obstacles=[]; coins=[];
      rocket.x = canvas.width/2-25;
      rocket.y = canvas.height-100;
      running = true;
      requestAnimationFrame(loop);
    };

    function spawnObstacle() {
      obstacles.push({ x: Math.random()*(canvas.width-40), y:-40, w:40, h:40 });
    }
    function spawnCoin() {
      coins.push({ x: Math.random()*(canvas.width-20), y:-20, w:20, h:20 });
    }

    function loop() {
      if (!running) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Draw rocket
      ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.width, rocket.height);

      // Obstacles
      if (Math.random()<0.02) spawnObstacle();
      obstacles.forEach(o => { o.y+=3; ctx.drawImage(obstacleImg,o.x,o.y,o.w,o.h); });
      obstacles = obstacles.filter(o => o.y<canvas.height);

      // Coins
      if (Math.random()<0.02) spawnCoin();
      coins.forEach(c => { c.y+=2; ctx.drawImage(coinImg,c.x,c.y,c.w,c.h); });
      coins = coins.filter(c => c.y<canvas.height);

      // Collisions
      for (let o of obstacles) {
        if (collision(rocket,o)) { endGame(); return; }
      }
      for (let i=coins.length-1;i>=0;i--) {
        if (collision(rocket,coins[i])) { score++; coins.splice(i,1); }
      }

      // Score text
      ctx.fillStyle="white"; ctx.font="20px Arial";
      ctx.fillText("–û–Ω–æ–æ: "+score,10,30);

      requestAnimationFrame(loop);
    }

    function collision(a,b) {
      return a.x<a.x+a.width &&
             a.x+b.w > b.x &&
             a.y+b.h > b.y &&
             a.y < b.y+b.h &&
             a.x+a.width > b.x;
    }

    async function endGame() {
      running = false;
      // save score
      const scoresRef = ref(db,"scores");
      const newRef = push(scoresRef);
      await set(newRef,{ username: currentUser, score, createdAt:new Date().toISOString() });
      // show leaderboard
      showLeaderboard();
    }

    async function showLeaderboard() {
      leaderboardScreen.style.display="flex";
      leaderboardBody.innerHTML="";
      const snapshot = await get(child(ref(db),"scores"));
      if (snapshot.exists()) {
        let data = Object.entries(snapshot.val()).map(([id,val])=>({id,...val}));
        data.sort((a,b)=>b.score-a.score);
        data.forEach(row=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${row.username}</td><td>${row.score}</td><td>${new Date(row.createdAt).toLocaleString()}</td>`;
          if (currentUser==="betermux") {
            const td=document.createElement("td");
            td.innerHTML=`<button onclick="updateScore('${row.id}')">Edit</button>
                          <button onclick="deleteScore('${row.id}')">Delete</button>`;
            tr.appendChild(td);
          }
          leaderboardBody.appendChild(tr);
        });
        if (currentUser==="betermux") adminCol.textContent="Admin";
      }
    }

    window.deleteScore = async (id) => {
      await remove(ref(db,"scores/"+id));
      showLeaderboard();
    };
    window.updateScore = async (id) => {
      const newScore=prompt("–®–∏–Ω—ç –æ–Ω–æ–æ:");
      if (newScore) {
        await update(ref(db,"scores/"+id),{score:parseInt(newScore)});
        showLeaderboard();
      }
    };

    window.restart = () => {
      leaderboardScreen.style.display="none";
      homeScreen.style.display="flex";
    };
  </script>
</body>
</html>